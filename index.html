<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>InsightTrack</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- (AG Grid assets left as-is but unused) -->
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.2/styles/ag-grid.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.2/styles/ag-theme-alpine-dark.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.2/styles/ag-theme-alpine.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@32.3.2/dist/ag-grid-enterprise.min.js"></script>
    <!-- Chart.js + Lucide -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Lucide UMD: includes createIcons + full icons map -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer data-lucide-umd></script>
    <style>
        /* ===== Touch nice ===== */
        html,
        body,
        #content,
        #table-container,
        .table-scroll {
            touch-action: pinch-zoom pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        /* ---------- Theme ---------- */
        :root {
            --bg-main: #1f2329;
            --bg-main-2: #232832;
            --panel: #2a2f37;
            --panel-2: #313743;
            --line: #3a414b;
            --text: #e8ecf1;
            --muted: #b4bcc7;
            --brand: #ffd605;
            --accent: #26A69A;
            --accent-2: #5b9bff;
            --bad: #cf2525;
            --ok: #10b981;
            --warn: #f59e0b;
            --ico-deposit: #22c55e;
            --ico-withdraw: #8b5cf6;
            --ico-net: #3b82f6;
            --ico-cwl: #ef4444;
            --ico-netwl: #f59e0b;
            --ico-currency: #f59e0b;
            --ico-ftd: #14b8a6;
            --ico-bonus: #ec4899;
            --ico-turnover: #6366f1;
            --col-first-width: 220px;
            /* Brand Group / first frozen col */
            --col-second-width: 140px;
            --hl-row: rgba(59, 130, 246, .10);
            --hl-row-strong: rgba(59, 130, 246, .16);
            --hl-row-mask: rgba(59, 130, 246, .92);
        }

        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--text);
            background: linear-gradient(180deg, var(--bg-main) 0%, var(--bg-main-2) 100%);
            font-size: clamp(14px, 2vw, 16px);
            line-height: 1.6;
        }

        .page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        #grid-container {
            width: 100%;
            height: 82vh;
            min-height: 700px;
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .30);
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .theme-light {
            --bg-main: #f6f8fb;
            --bg-main-2: #ffffff;
            --panel: #ffffff;
            --panel-2: #f8fafc;
            --line: #e5e7eb;
            --text: #0f172a;
            --muted: #475569;
            --brand: #c084fc;
            --accent: #0ea5e9;
            --accent-2: #3b82f6;
            --bad: #dc2626;
            --ok: #059669;
            --warn: #d97706;
            --ico-deposit: #16a34a;
            --ico-withdraw: #7c3aed;
            --ico-net: #2563eb;
            --ico-cwl: #dc2626;
            --ico-netwl: #d97706;
            --ico-currency: #b45309;
            --ico-ftd: #0d9488;
            --ico-bonus: #db2777;
            --ico-turnover: #4f46e5;
            --hl-row: rgba(14, 165, 233, .10);
            --hl-row-strong: rgba(14, 165, 233, .16);
            --hl-row-mask: rgba(14, 165, 233, .92);
        }

        .theme-light .btn-template {
            background: #fff;
            color: var(--text);
            border-color: var(--line)
        }

        .theme-light .btn-template:hover {
            background: #f3f4f6
        }

        .theme-light .input-template,
        .theme-light .select-template {
            background: #fff;
            color: var(--text);
            border-color: var(--line)
        }

        .theme-light header {
            background: var(--panel)
        }

        .theme-light .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 8px 22px rgba(14, 165, 233, .28);
        }

        .select-template {
            appearance: none;
            background: #1a1f27;
            color: var(--text);
            padding-right: 2rem;
            border: 1px solid var(--line)
        }

        .select-chevron {
            transition: transform .15s ease;
            opacity: .9;
        }

        .select-wrap select {
            min-width: 10rem;
        }

        .select-wrap.open .select-chevron {
            transform: translateY(-50%) rotate(180deg);
        }

        .select-template option {
            background: #1a1f27;
            color: var(--text)
        }

        .theme-light .select-template {
            background: #fff;
            color: var(--text)
        }

        .theme-light .select-template option {
            background: #fff;
            color: var(--text)
        }

        .card-heading .ico {
            color: var(--accent);
        }

        .ico-deposit {
            color: var(--ico-deposit);
        }

        .ico-withdraw {
            color: var(--ico-withdraw);
        }

        .ico-net {
            color: var(--ico-net);
        }

        .ico-cwl {
            color: var(--ico-cwl);
        }

        .ico-netwl {
            color: var(--ico-netwl);
        }

        .ico-ftd {
            color: var(--ico-ftd);
        }

        .ico-bonus {
            color: var(--ico-bonus);
        }

        .ico-turnover {
            color: var(--ico-turnover);
        }

        .lucide[data-lucide="coins"] {
            color: var(--ico-currency);
        }

        .theme-light #themeIcon .lucide {
            color: #f59e0b;
        }

        body:not(.theme-light) #themeIcon .lucide {
            color: #94a3b8;
        }

        .theme-christmas {
            --bg-main: #1a3c34;
            --bg-main-2: #2e4b47;
            --panel: #3d5a55;
            --panel-2: #4a6b66;
            --line: #6b8e87;
            --text: #e6f0ea;
            --muted: #a8c7b6;
            --brand: #ff4d4f;
            --accent: #25c2a0;
            --accent-2: #40c4ff;
            --bad: #b71c1c;
            --ok: #1b5e20;
            --warn: #ff9100;
            --ico-deposit: #4caf50;
            --ico-withdraw: #ab47bc;
            --ico-net: #0288d1;
            --ico-cwl: #d81b60;
            --ico-netwl: #ff9100;
            --ico-currency: #ff9100;
            --ico-ftd: #26a69a;
            --ico-bonus: #f06292;
            --ico-turnover: #7e57c2;
            --hl-row: rgba(255, 77, 79, .15);
            --hl-row-strong: rgba(255, 77, 79, .25);
            --hl-row-mask: rgba(255, 77, 79, .95);
            background: url('https://images.unsplash.com/photo-1542587221-33a95f33a4b3') no-repeat center/cover, linear-gradient(180deg, var(--bg-main) 0%, var(--bg-main-2) 100%);
        }

        .theme-christmas.theme-light {
            --bg-main: #e0f0eb;
            --bg-main-2: #f0f8f5;
            --panel: #d1e8e2;
            --panel-2: #e6f2ee;
            --line: #a2c8c0;
            --text: #1a3c34;
            --muted: #5a8a80;
            --brand: #ff8a8c;
            --accent: #1e8b7a;
            --accent-2: #6abaff;
            --bad: #a32c2c;
            --ok: #146c1e;
            --warn: #ffaa33;
            --ico-deposit: #2e7d32;
            --ico-withdraw: #7b1fa2;
            --ico-net: #01579b;
            --ico-cwl: #c2185b;
            --ico-netwl: #ffaa33;
            --ico-currency: #ffaa33;
            --ico-ftd: #00695c;
            --ico-bonus: #ad1457;
            --ico-turnover: #4527a0;
            --hl-row: rgba(255, 138, 140, .15);
            --hl-row-strong: rgba(255, 138, 140, .25);
            --hl-row-mask: rgba(255, 138, 140, .95);
            background: url('https://images.unsplash.com/photo-1608248630260-c2e86d720dd8') no-repeat center/cover, linear-gradient(180deg, var(--bg-main) 0%, var(--bg-main-2) 100%);
        }

        .theme-christmas.theme-light .btn-template {
            background: #e6f2ed;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-christmas.theme-light .btn-template:hover {
            background: #d9e8e2;
        }

        .theme-christmas.theme-light .tab {
            background: #e6f2ed;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-christmas.theme-light .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
            font-weight: 700;
        }

        .theme-christmas.theme-light .select-template {
            background: #e6f2ed;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-christmas.theme-light .multi .multi-pop {
            background: linear-gradient(180deg, #e6f2ed, #f9fcfb);
            border-color: #b0c9c2;
        }

        .theme-christmas.theme-light .multi .multi-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .theme-christmas .modal-panel,
        .theme-christmas .card-template {
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--glow-border);
        }

        .theme-christmas .tab.active,
        .theme-christmas .btn-template:hover {
            animation: glow 1s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            }

            to {
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        .theme-christmas .kpi-card:hover {
            transform: scale(1.05) rotate(2deg);
            /* Bounce on hover */
            transition: transform 0.3s ease;
        }

        .theme-christmas th {
            background: url('data:image/svg+xml;base64,[BASE64_SNOWFLAKE_PATTERN]') repeat;
            /* Replace with snowflake pattern base64 */
            position: sticky;
            /* Already there, but ensure content behind hidden */
            z-index: 10;
        }

        .theme-christmas th::after {
            /* Hide content behind sticky headers */
            content: '';
            position: absolute;
            inset: 0;
            background: var(--panel-2);
            z-index: -1;
        }

        .theme-christmas .notification {
            /* Animated banners */
            animation: pulse 2s infinite;
            background: rgba(255, 77, 79, 0.2);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .theme-christmas .tooltip {
            /* Festive tooltips */
            animation: sparkle 1s infinite;
        }

        @keyframes sparkle {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .theme-christmas .tab {
            /* Smooth transitions */
            transition: all 0.3s ease;
        }

        .theme-chinese-new-year {
            --bg-main: #4b1c1c;
            --bg-main-2: #6b2a2a;
            --panel: #8b3737;
            --panel-2: #a84545;
            --line: #d47c7c;
            --text: #f5e9e9;
            --muted: #d4a8a8;
            --brand: #ffca28;
            --accent: #ff7043;
            --accent-2: #ef5350;
            --bad: #b71c1c;
            --ok: #388e3c;
            --warn: #f57c00;
            --ico-deposit: #66bb6a;
            --ico-withdraw: #ce93d8;
            --ico-net: #29b6f6;
            --ico-cwl: #e91e63;
            --ico-netwl: #ffca28;
            --ico-currency: #ffca28;
            --ico-ftd: #26c6da;
            --ico-bonus: #f06292;
            --ico-turnover: #9575cd;
            --hl-row: rgba(255, 202, 40, .15);
            --hl-row-strong: rgba(255, 202, 40, .25);
            --hl-row-mask: rgba(255, 202, 40, .95);
            background: url('data:image/svg+xml;base64,[BASE64_LANTERN_SCENE]') no-repeat center/cover, linear-gradient(180deg, var(--bg-main) 0%, var(--bg-main-2) 100%);
        }

        .theme-chinese-new-year.theme-light {
            --bg-main: #f0d8d8;
            --bg-main-2: #f8e6e6;
            --panel: #e6baba;
            --panel-2: #f0cccc;
            --line: #d47c7c;
            --text: #4b1c1c;
            --muted: #a65c5c;
            --brand: #ffd54f;
            --accent: #ff8a65;
            --accent-2: #f88379;
            --bad: #7f1d1d;
            --ok: #2f7d32;
            --warn: #fb8c00;
            --ico-deposit: #43a047;
            --ico-withdraw: #ab47bc;
            --ico-net: #0288d1;
            --ico-cwl: #d81b60;
            --ico-netwl: #ffd54f;
            --ico-currency: #ffd54f;
            --ico-ftd: #00acc1;
            --ico-bonus: #ec407a;
            --ico-turnover: #7e57c2;
            --hl-row: rgba(255, 213, 79, .15);
            --hl-row-strong: rgba(255, 213, 79, .25);
            --hl-row-mask: rgba(255, 213, 79, .95);
            background: url('data:image/svg+xml;base64,[BASE64_LANTERN_SCENE]') no-repeat center/cover, linear-gradient(180deg, var(--bg-main) 0%, var(--bg-main-2) 100%);
        }

        .theme-chinese-new-year.theme-light .btn-template {
            background: #f4dada;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-chinese-new-year.theme-light .btn-template:hover {
            background: #eed0d0;
        }

        .theme-chinese-new-year.theme-light .tab {
            background: #f4dada;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-chinese-new-year.theme-light .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
            font-weight: 700;
        }

        .theme-chinese-new-year.theme-light .select-template {
            background: #f4dada;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-chinese-new-year.theme-light .multi .multi-pop {
            background: linear-gradient(180deg, #f4dada, #fdebeb);
            border-color: #d4a8a8;
        }

        .theme-chinese-new-year.theme-light .multi .multi-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Chart Colors for Light Mode */
        .theme-christmas.theme-light .chart-wrap canvas {
            --chart-text: #1e3a3a;
            --chart-grid: rgba(46, 125, 50, 0.2);
            --chart-tooltip-bg: rgba(230, 242, 237, 0.95);
            --chart-s1: #2e7d32;
            --chart-s2: #1976d2;
            --chart-s3: #ed6c02;
        }

        .theme-chinese-new-year.theme-light .chart-wrap canvas {
            --chart-text: #4b1c1c;
            --chart-grid: rgba(239, 83, 80, 0.2);
            --chart-tooltip-bg: rgba(244, 218, 218, 0.95);
            --chart-s1: #ef5350;
            --chart-s2: #0288d1;
            --chart-s3: #ff9800;
        }

        .theme-chinese-new-year .modal-panel,
        .theme-chinese-new-year .card-template {
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }

        .theme-chinese-new-year .kpi-card:hover {
            transform: translateY(-5px);
            /* Lantern swing */
            transition: transform 0.3s ease;
        }

        .theme-chinese-new-year th {
            background: linear-gradient(to right, red, gold);
            /* Red/gold headers */
            position: sticky;
            z-index: 10;
        }

        .theme-chinese-new-year th::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--panel-2);
            z-index: -1;
        }

        .theme-chinese-new-year .notification {
            animation: burst 2s infinite;
            background: rgba(255, 112, 67, 0.2);
        }

        @keyframes burst {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
            }
        }

        .theme-chinese-new-year .tooltip {
            animation: lantern-swing 1s infinite alternate;
        }

        @keyframes lantern-swing {
            from {
                transform: rotate(-5deg);
            }

            to {
                transform: rotate(5deg);
            }
        }

        .theme-chinese-new-year .tab {
            transition: all 0.3s ease;
        }

        /* Shared Festive Features */
        body.theme-christmas,
        body.theme-chinese-new-year {
            transition: background 0.5s ease;
            /* Smooth theme switch */
        }

        .btn-template,
        .kpi-card,
        .tab {
            animation: fadeIn 0.5s ease;
            /* Micro-interactions */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-template:hover {
            transform: scale(1.05);
            /* Hover scale */
            box-shadow: 0 0 10px var(--accent);
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            border-radius: 10px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                right: -100%;
            }

            to {
                right: 10px;
            }
        }

        /* Particle Density Control (slider) */
        #particleDensity {
            width: 100px;
        }

        /* Accessibility: High contrast */
        .theme-christmas .text,
        .theme-chinese-new-year .text {
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* Keyboard Navigation Focus */
        button:focus,
        select:focus,
        input:focus {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }

        .theme-christmas .btn-template {
            background: #4a6b66;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-christmas .btn-template:hover {
            background: #5a7b76;
        }

        .theme-christmas .input-template,
        .theme-christmas .select-template {
            background: #3d5a55;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-christmas header {
            background: var(--panel);
        }

        .theme-christmas .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 8px 22px rgba(37, 194, 160, .28);
        }

        .theme-chinese-new-year .btn-template {
            background: #a84545;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-chinese-new-year .btn-template:hover {
            background: #b85555;
        }

        .theme-chinese-new-year .input-template,
        .theme-chinese-new-year .select-template {
            background: #8b3737;
            color: var(--text);
            border-color: var(--line);
        }

        .theme-chinese-new-year header {
            background: var(--panel);
        }

        .theme-chinese-new-year .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 8px 22px rgba(255, 112, 67, .28);
        }

        .theme-christmas .kpi-card {
            background: linear-gradient(180deg, #3d5a55, #4a6b66);
            border-color: var(--line);
        }

        .theme-chinese-new-year .kpi-card {
            background: linear-gradient(180deg, #8b3737, #a84545);
            border-color: var(--line);
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .tab {
            background: var(--panel-2);
            border-color: var(--line);
            color: var(--text);
            transition: background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
        }

        .tab:hover {
            border-color: var(--accent-2);
        }

        .tab.active {
            background: #ef4444;
            border-color: #ef4444;
            color: #fff;
            box-shadow: 0 8px 22px rgba(239, 68, 68, .28);
        }

        .card-template,
        .kpi-card {
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
            animation: fadeUp .45s ease both;
            will-change: transform, box-shadow;
        }

        .card-template:hover,
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 32px rgba(0, 0, 0, .35)
        }

        .card-template {
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--line);
            border-radius: 14px;
            box-shadow: 0 8px 22px rgba(0, 0, 0, .28);
            position: relative;
        }

        .card-heading {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-weight: 600
        }

        .card-heading .ico {
            width: 18px;
            height: 18px;
            opacity: .9
        }

        .kpi-card {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: .9rem 1.1rem;
            background: linear-gradient(180deg, #151a21 0%, #1a1f27 100%);
            min-width: 200px;
        }

        .kpi-card .topline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .5rem;
            margin-bottom: 2px
        }

        .kpi-card .label {
            font-size: .8rem;
            color: #9aa3ae
        }

        .kpi-card .value {
            font-weight: 800;
            font-size: 1.25rem;
            color: #e9edf4
        }

        .kpi-card .ico {
            width: 22px;
            height: 22px;
            opacity: .9
        }

        .inline-loader {
            position: absolute;
            inset: 0;
            display: none;
            place-items: center;
            background: rgba(0, 0, 0, .12);
            z-index: 5;
            border-radius: inherit
        }

        .inline-loader.show {
            display: grid
        }

        .inline-loader .dot {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            border: 3px solid transparent;
            border-top-color: var(--accent);
            animation: spin .6s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .chart-wrap {
            position: relative;
            height: 320px
        }

        .chart-wrap canvas {
            width: 100% !important;
            height: 100% !important;
            display: block
        }

        .numeric-negative,
        .percentage-negative {
            color: var(--bad) !important;
            font-weight: 700
        }

        @media (max-width:768px) {
            .chart-wrap {
                height: 260px
            }

            #grid-container {
                height: 500px
            }
        }

        .btn-template {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--line);
            background: #2b313b;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-template:hover {
            background: #323846
        }

        .input-template,
        .select-template {
            padding: 8px 10px;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: #1a1f27;
            color: var(--text);
            outline: none
        }

        .input-template:focus,
        .select-template:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(38, 166, 154, .25)
        }

        #refresh[aria-busy="true"] {
            opacity: .8;
            pointer-events: none
        }

        #refresh[aria-busy="true"] svg {
            animation: spin .8s linear infinite;
            transform-origin: center
        }

        header label .lucide {
            color: var(--accent);
        }

        .btn-template .lucide,
        .tab .lucide,
        header .lucide,
        label .lucide,
        .card-heading .ico .lucide {
            color: var(--accent-2);
        }

        .btn-template:hover .lucide,
        .tab.active .lucide {
            color: var(--accent);
        }

        .kpi-card .ico .lucide {
            color: currentColor;
        }

        .tab .lucide {
            color: #10b981;
        }

        .tab.active .lucide {
            color: #fff;
        }

        /* ==== Brand toggle */
        .brand-toggle {
            position: relative;
            overflow: visible;
        }

        .brand-toggle .brand-core {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            display: inline-grid;
            place-items: center;
            background: linear-gradient(180deg, var(--panel-2), var(--panel));
            box-shadow: inset 0 0 0 1px var(--line), 0 8px 18px rgba(0, 0, 0, .25);
            position: relative;
            z-index: 1;
        }

        .brand-toggle .brand-trace {
            position: absolute;
            inset: -2px;
            border-radius: 12px;
            background: conic-gradient(from var(--deg, 0deg), var(--accent) 0%, var(--accent-2) 25%, var(--brand) 50%, var(--accent) 75%, var(--accent-2) 100%);
            -webkit-mask: radial-gradient(circle at center, transparent 18px, #000 19px) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            padding: 2px;
            opacity: .9;
        }

        #brandToggle[data-mode="spin"] .brand-trace {
            animation: spin 5s linear infinite;
        }

        #brandToggle[data-mode="pulse"] .brand-trace {
            animation: brandPulse 1.4s ease-in-out infinite;
        }

        #brandToggle[data-mode="off"] .brand-trace {
            animation: none;
            opacity: .55;
        }

        @keyframes brandPulse {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.06)
            }
        }

        .brand-toggle .lucide {
            color: #f59e0b;
        }

        /* ===== Modal (unchanged) ===== */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 60;
        }

        .modal.open {
            display: block;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            opacity: 0;
            animation: modalFade .18s ease forwards;
        }

        .modal-panel {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 0;
            border-radius: 0;
            color: var(--text);
            display: grid;
            grid-template-rows: auto 1fr auto;
            opacity: 0;
            animation: panelInFull .22s cubic-bezier(.2, .8, .2, 1) .02s forwards;
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
            padding: .9rem 1rem;
            border-bottom: 1px solid var(--line);
            position: relative;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.05rem;
            display: flex;
            gap: .5rem;
            align-items: center;
        }

        .modal-body {
            padding: 1rem clamp(.75rem, 3vw, 1.25rem);
            overflow: auto;
            max-height: none;
            height: auto;
        }

        .modal-foot {
            padding: .8rem 1rem;
            border-top: 1px solid var(--line);
            display: flex;
            justify-content: flex-end;
            gap: .5rem;
        }

        .modal .btn {
            border: 1px solid var(--line);
            background: var(--panel-2);
            color: var(--text);
            border-radius: 10px;
            padding: .55rem .8rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            cursor: pointer;
        }

        .modal .btn:hover {
            background: #323846;
        }

        @keyframes panelInFull {
            from {
                opacity: 0;
                transform: translateY(2%)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .theme-light .modal .btn:hover {
            background: #f3f4f6;
        }

        .formula-list {
            display: grid;
            gap: .65rem;
        }

        .formula {
            display: grid;
            grid-template-columns: 210px 1fr;
            gap: .6rem;
            align-items: start;
            border: 1px dashed var(--line);
            border-radius: 12px;
            padding: .6rem .8rem;
            background: rgba(0, 0, 0, .03);
            animation: rowUp .28s ease both;
        }

        .theme-light .formula {
            background: rgba(0, 0, 0, .02);
        }

        .formula .lhs {
            display: flex;
            align-items: center;
            gap: .45rem;
            font-weight: 700;
            color: var(--text);
        }

        .ico-formula {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            opacity: .95;
        }

        .if-blue {
            color: #3b82f6
        }

        .if-amber {
            color: #f59e0b
        }

        .if-teal {
            color: #14b8a6
        }

        .if-red {
            color: #ef4444
        }

        .if-green {
            color: #22c55e
        }

        .if-violet {
            color: #8b5cf6
        }

        .if-pink {
            color: #ec4899
        }

        .if-indigo {
            color: #6366f1
        }

        .if-cyan {
            color: #06b6d4
        }

        .formula .rhs {
            color: var(--text);
            opacity: .95;
        }

        .formula small {
            color: var(--muted);
            display: block;
            margin-top: .25rem;
        }

        .frac {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.15;
        }

        .frac .bar {
            display: block;
            width: 100%;
            border-top: 1.6px solid var(--line);
            margin: 2px 0 1px;
        }

        .code-kpi {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            background: rgba(0, 0, 0, .06);
            padding: .1rem .35rem;
            border-radius: .35rem;
            border: 1px solid var(--line);
        }

        .modal-head:after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: .7;
            animation: shimmer 2.4s linear infinite;
        }

        @keyframes modalFade {
            to {
                opacity: 1
            }
        }

        @keyframes rowUp {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -120% 0
            }

            100% {
                background-position: 220% 0
            }
        }

        /* ===== Multi-select filter ===== */
        .multi {
            position: relative;
        }

        .multi .multi-btn {
            white-space: nowrap;
        }

        .multi.open .multi-btn .lucide {
            color: var(--accent);
        }

        /* Popover opens by toggling .open on the .multi root (no display:none) */
        .multi .multi-pop {
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            min-width: 220px;
            max-height: 300px;
            overflow: hidden;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, .35);
            z-index: 40;
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity .12s ease, transform .12s ease;
            pointer-events: none;
        }

        .multi .multi-scroll {
            max-height: 240px;
            overflow: auto;
            padding: 8px;
        }

        .multi .multi-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .multi .multi-item:hover {
            background: rgba(0, 0, 0, .06);
        }

        .multi .multi-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid var(--line);
            justify-content: flex-end;
        }

        .hidden {
            display: none;
        }

        /* ===================== TABLE STYLE (new) ===================== */
        .tgrid-wrap {
            position: absolute;
            inset: 0;
            overflow: auto;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
        }

        table.tgrid {
            width: max-content;
            /* grow to fit content */
            min-width: 100%;
            /* but never smaller than container */
            border-collapse: separate;
            border-spacing: 0;
            font-variant-numeric: tabular-nums;
            table-layout: auto;
            /* allow natural column sizes */
        }

        .tgrid th,
        .tgrid td {
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            padding: 8px 12px;
            font-size: 13px;
            line-height: 1.4;
            vertical-align: middle;
            /* NEW */
        }

        /* HEADER — keep above body cells */
        .tgrid thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--panel-2);
            color: var(--text);
            border-bottom: 1px solid var(--line);
            padding: 8px 12px;
            /* tighter */
            font-weight: 700;
            text-align: center;
            font-size: 12.5px;
            /* compact header */
        }

        .tgrid thead th.sticky-first,
        .tgrid thead th.sticky-second {
            z-index: 6;
        }

        /* Center the utility toolbar row inside the table header */
        .tgrid thead .row-alt>td>.flex {
            justify-content: center;
        }

        /* Group band: only the FIRST cell sticks (fixes overlap bug) */
        .tgrid .group-band td {
            background: var(--panel);
            color: var(--text);
            font-weight: 700;
            border-bottom-color: var(--line);
        }

        .tgrid .group-band td:first-child {
            position: sticky;
            left: 0;
            z-index: 3;
        }

        /* divider for frozen col */
        .tgrid .sticky-first,
        .tgrid thead th.sticky-first {
            box-shadow: 1px 0 0 0 var(--line) inset;
        }

        /* Center all body cells (PR & DW) */
        .tgrid tbody td {
            border-bottom: 1px solid var(--line);
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }

        /* Numeric cells: center as well */
        .tgrid td.num,
        .tgrid td.num-neg {
            text-align: center;
        }

        /* First column also centered */
        .tgrid tbody td:first-child {
            text-align: center;
        }

        .tgrid .group-band td,
        .tgrid .brand-row td {
            text-align: center;
        }

        .tgrid .row-alt {
            background: rgba(255, 255, 255, .02);
        }

        .tgrid .brand-row td {
            background: rgba(0, 0, 0, .04);
        }

        .tgrid .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 700;
            font-size: .75rem;
            border: 1px solid var(--line);
            background: #1f2937;
        }

        .theme-light .tgrid .pill {
            background: #f8fafc
        }

        .tgrid .num-neg {
            color: var(--bad);
            font-weight: 800;
        }

        .tgrid .row-net {
            background: rgba(245, 158, 11, .11);
        }

        .tgrid .toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* NEW */
            gap: 6px;
            cursor: pointer;
            margin: 0 auto;
            /* helps centering in the cell */
        }

        .tgrid .toggle .lucide {
            width: 16px;
            height: 16px;
            transition: transform .16s ease, opacity .16s ease;
        }

        /* solid stickies; inline row colors will show and mask cells behind */
        .sticky-first,
        .sticky-second {
            position: sticky;
            background-clip: padding-box;
        }

        .sticky-first {
            left: 0;
            z-index: 3;
        }

        .sticky-second {
            left: var(--col-first-width, 220px);
            z-index: 2;
        }

        .col-first {
            width: var(--col-first-width, 220px);
        }

        .col-second {
            width: var(--col-second-width, 140px);
        }

        /* --- HEADER SORT & FILTER UI --- */
        .tgrid th .hdr {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .4rem;
            position: relative;
        }

        .tgrid th .hdr-btn {
            display: inline-grid;
            place-items: center;
            width: 22px;
            height: 22px;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
        }

        .tgrid th .hdr-btn:hover {
            border-color: var(--line);
            background: rgba(255, 255, 255, .04);
        }

        .tgrid th .hdr .txt {
            white-space: nowrap;
        }

        /* readable headers */
        .tgrid th.sorted .hdr-btn.sort {
            color: var(--accent);
        }

        /* render above the table; JS positions it near the button */
        .tgrid th .filter-pop {
            position: fixed;
            left: 0;
            top: 0;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: .55rem;
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
            z-index: 100000;
            /* guarantee above table */
            display: none;
        }

        .tgrid th.open .filter-pop {
            display: block;
        }

        .tgrid th .filter-pop input {
            width: 180px;
        }

        /* === KPI — LIGHT THEME (make them light instead of dark) === */
        .theme-light .kpi-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-color: var(--line);
            color: var(--text);
        }

        .theme-light .kpi-card .label {
            color: var(--muted)
        }

        .theme-light .kpi-card .value {
            color: var(--text)
        }

        /* === NEW: stacked 3-line metric cells + smoother interactions === */
        .tgrid tbody tr {
            animation: rowUp .24s ease both;
        }

        .tgrid tbody td {
            transition: background-color .14s ease, opacity .14s ease;
        }

        .multi.open .multi-pop {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .stack3 {
            display: flex;
            flex-direction: column;
            gap: 2px;
            line-height: 1.15;
        }

        .stack3 .ln {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-variant-numeric: tabular-nums;
        }

        .stack3 .ln .lucide {
            width: 14px;
            height: 14px;
            opacity: .9;
        }

        .stack3 .dep {
            color: var(--ico-deposit);
        }

        .stack3 .wdr {
            color: var(--ico-withdraw);
        }

        .stack3 .net {
            color: var(--ico-net);
        }

        /* DW table: make negative Net Deposit red & bold */
        .stack3 .net.neg,
        .stack3 .net.neg .lucide {
            color: var(--bad);
            font-weight: 800;
        }

        @media (prefers-reduced-motion: reduce) {
            .tgrid tbody tr {
                animation: none;
            }

            .multi .multi-pop {
                transition: none;
            }

            .tgrid .toggle .lucide {
                transition: none;
            }
        }

        /* ===== Rate modal table (scoped) — UPDATED ===== */
        #rateModal {
            position: fixed;
            inset: 0;
            z-index: 80;
            display: none;
            place-items: center
        }

        #rateModal.open {
            display: block
        }

        #rateModal .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .6)
        }

        #rateModal .modal-panel {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            display: grid;
            grid-template-rows: auto 1fr auto;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 0
        }

        #rateModal .modal-head {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border-bottom: 1px solid var(--line);
            padding: .9rem 1rem
        }

        #rateModal .tab-nav {
            display: flex;
            gap: .5rem;
            margin-bottom: .5rem
        }

        #rateModal .tab-btn {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .5rem 1rem;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: var(--panel-2);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all .2s ease
        }

        #rateModal .tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        #rateModal .tab-btn .lucide {
            width: 16px;
            height: 16px
        }

        #rateModal .tab-content {
            display: none;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity .3s ease, transform .3s ease
        }

        #rateModal .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0)
        }

        #rateModal .modal-body {
            max-height: none;
            height: auto;
            overflow: auto
        }

        #rateModal .fx-wrap {
            position: relative;
            border: 1px solid var(--line);
            border-radius: 10px;
            overflow: visible;
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            width: 100%;
            margin: 0;
            isolation: isolate
        }

        #rateModal table.fx {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-variant-numeric: tabular-nums
        }

        #rateModal thead {
            position: sticky;
            top: 0;
            z-index: 500;
            background: var(--panel-2)
        }

        #rateModal thead th {
            position: sticky;
            top: 0;
            z-index: 600;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .4px;
            background: var(--panel-2);
            background-clip: padding-box;
            color: var(--text);
            border-bottom: 1px solid var(--line);
            padding: 10px 12px;
            text-align: center;
            box-shadow: 0 2px 0 var(--line), 0 8px 18px rgba(0, 0, 0, .35)
        }

        #rateModal thead th:first-child {
            z-index: 610;
            text-align: left
        }

        #rateModal th:first-child,
        #rateModal td:first-child {
            position: sticky;
            left: 0;
            z-index: 90;
            background: var(--panel-2);
            border-right: 1px solid var(--line);
            box-shadow: 2px 0 0 var(--line);
            text-align: left
        }

        #rateModal td:not(:first-child),
        #rateModal thead th:not(:first-child) {
            text-align: center
        }

        #rateModal td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--line);
            vertical-align: middle
        }

        #rateModal tbody tr:nth-child(odd) td {
            background: rgba(255, 255, 255, .02)
        }

        #rateModal tbody tr:nth-child(even) td {
            background: rgba(255, 255, 255, .015)
        }

        #rateModal .ccy {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            font-weight: 700;
            letter-spacing: .2px
        }

        #rateModal .muted {
            color: var(--muted);
            font-weight: 600;
            font-size: 11px
        }

        #rateModal .flag {
            width: 32px;
            height: 22px;
            border-radius: 6px;
            display: grid;
            place-items: center;
            background: #14151a;
            border: 1px solid var(--line);
            overflow: hidden;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .35)
        }

        #rateModal .rate,
        #rateModal .mono {
            font-variant-numeric: tabular-nums
        }

        #rateModal .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #14151a;
            border: 1px solid #2b2f39;
            color: var(--muted)
        }

        #rateModal .chip.good {
            color: #dbeafe;
            background: rgba(96, 165, 250, .12);
            border-color: rgba(96, 165, 250, .35)
        }

        #rateModal .chip.bad {
            color: #ffedd5;
            background: rgba(251, 146, 60, .12);
            border-color: rgba(251, 146, 60, .40)
        }

        /* ===== Version Engine: overlays & banners ===== */
        .version-banner {
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 70;
            padding: .5rem .9rem;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            color: var(--text);
            box-shadow: 0 12px 30px rgba(0, 0, 0, .35);
            display: none;
            align-items: center;
            gap: .5rem;
            font-weight: 700
        }

        .version-banner.show {
            display: flex;
            animation: fadeUp .45s ease both
        }

        .version-banner .lucide {
            opacity: .9
        }

        /* lightweight particles canvas (no lib) */
        #fx-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5
        }

        body>#fx-overlay {
            mix-blend-mode: normal
        }

        /* Lanterns container */
        .lanterns {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 6;
            display: none
        }

        .lantern {
            position: absolute;
            width: 16px;
            height: 22px;
            opacity: .75;
            filter: drop-shadow(0 6px 10px rgba(0, 0, 0, .5))
        }

        .lantern svg {
            display: block
        }

        @keyframes driftV {
            0% {
                transform: translateY(-10%)
            }

            100% {
                transform: translateY(110%)
            }
        }

        @keyframes sway {

            0%,
            100% {
                transform: translateX(-6px)
            }

            50% {
                transform: translateX(6px)
            }
        }

        /* Show overlays per version */
        .theme-christmas #fx-overlay {
            display: block
        }

        .theme-chinese-new-year .lanterns {
            display: block
        }

        /* Welcome Banner Animations */
        .welcome-banner {
            animation: slideIn 0.5s ease-out forwards, fadeOut 5s ease-out 5s forwards;
        }

        .welcome-icon {
            animation: bounce 1.5s infinite ease-in-out;
        }

        .welcome-text {
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .notification {
            background: var(--panel-2);
            border: 1px solid var(--line);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.5s ease-out, bounceOut 3s ease-out 2s forwards;
        }

        .notification.show {
            display: flex;
            animation: slideIn 0.5s ease-out, bounceOut 3s ease-out 2s forwards;
        }

        @keyframes bounceOut {
            0% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(10px);
            }

            100% {
                transform: translateX(100%);
                opacity: 0;
                visibility: hidden;
            }
        }

        /* Fortune Notification Animation */
        .notification.fortune {
            animation: slideInFortune 0.5s ease-out forwards, bounceFortune 0.3s ease-out 2.5s, fadeOutFortune 0.5s ease-out 2.8s forwards;
        }

        @keyframes slideInFortune {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes bounceFortune {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(10px);
            }
        }

        @keyframes fadeOutFortune {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* Sparkle Effect for Icons */
        @keyframes sparkle {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
            }

            50% {
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        /* --- Light mode: force bold text across both festive themes for better readability --- */
        .theme-christmas.theme-light :where(h1, h2, h3, h4, h5, h6, p, span, div, button, label, small, td, th, a, select, option),
        .theme-chinese-new-year.theme-light :where(h1, h2, h3, h4, h5, h6, p, span, div, button, label, small, td, th, a, select, option) {
            font-weight: 700 !important;
        }

        /* Optional: keep welcome icons sized consistently */
        .welcome-icons .lucide,
        #welcomeBanner svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-30 border-b" style="border-color:var(--line); background:var(--panel)">
        <div class="w-full px-0">
            <div class="page py-3 flex items-center gap-3 justify-between">
                <div class="flex items-center gap-2">
                    <!-- 🔄 Modern brand toggle button -->
                    <button id="brandToggle" class="btn-template brand-toggle" title="Mode" data-mode="spin">
                        <span class="brand-core"><i data-lucide="zap"></i></span>
                        <span class="brand-trace"></span>
                    </button>
                    <h1 class="text-lg font-semibold">InsightTrack</h1>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 card-template px-2 py-1">
                        <label class="text-sm text-[color:var(--muted)] flex items-center gap-1">
                            <i data-lucide="coins"></i><span>Currency</span>
                        </label>
                        <div class="select-wrap relative inline-flex items-center">
                            <select id="currency" class="select-template pr-8 text-sm bg-transparent focus:outline-none">
                                <option>Original</option>
                                <option>USD - Live</option>
                                <option>USD - MonthlyRate</option>
                            </select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                        <label class="text-sm text-[color:var(--muted)] flex items-center gap-1">
                            <i data-lucide="palette"></i><span>Version</span>
                        </label>
                        <div class="select-wrap relative inline-flex items-center">
                            <select id="version" class="select-template pr-8 text-sm bg-transparent focus:outline-none">
                                <option>Current Version</option>
                                <option>Merry Christmas</option>
                                <option>Chinese New Year</option>
                            </select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                        <button id="helper" class="btn-template" title="Open KPI & Formula Helper">
                            <i data-lucide="help-circle"></i>
                            <span class="txt">Helper</span>
                        </button>
                        <button id="rate" class="btn-template" title="Show monthly FX used">
                            <i data-lucide="circle-dollar-sign"></i><span>Rate</span>
                        </button>
                        <button id="theme" class="btn-template" title="Toggle light/dark">
                            <span id="themeIcon"><i data-lucide="moon-star"></i></span>
                            <span class="txt">Theme</span>
                        </button>
                        <canvas id="fx-overlay"></canvas>
                        <div class="lanterns" id="lanterns"></div>
                        <div class="version-banner" id="versionBanner">
                            <i data-lucide="sparkles"></i><span id="versionBannerText"></span>
                        </div>
                    </div>
                </div>
            </div>
    </header>
    <div id="welcomeBanner" class="version-banner welcome-banner" style="display:none;">
        <span id="welcomeIcons" class="welcome-icons flex items-center gap-1"></span>
        <span id="welcomeText" class="welcome-text"></span>
    </div>
    <div id="versionNotification" class="notification" style="display:none;">
        <i data-lucide="bell"></i><span id="notificationText"></span>
    </div>
    <div id="particleControl" class="flex items-center gap-2 ml-4">
        <label for="particleDensity">Particle Density:</label>
        <input type="range" id="particleDensity" min="0" max="100" value="50">
    </div>
    <!-- Tabs -->
    <nav class="w-full px-4 mt-4">
        <div class="page">
            <div class="flex flex-wrap gap-2">
                <button data-tab="pr" class="btn-template tab active" title="PR Monthly"><i data-lucide="table"></i><span class="txt">PR Monthly</span></button>
                <button data-tab="dw" class="btn-template tab" title="Deposit & Withdraw"><i data-lucide="wallet"></i><span class="txt">Deposit & Withdraw</span></button>
                <div class="grow"></div>
                <button id="refresh" class="btn-template" title="Refresh"><i data-lucide="refresh-cw"></i><span class="txt">Refresh</span></button>
            </div>
        </div>
    </nav>
    <!-- KPIs -->
    <section class="w-full px-4 mt-4">
        <div class="page">
            <div id="kpis" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="inline-loader" id="kpiLoader">
                    <div class="dot"></div>
                </div>
                <div class="kpi-card" id="kpiDepositWrap">
                    <div class="topline">
                        <div class="label">Total Deposit</div><span class="ico ico-deposit"><i data-lucide="banknote"></i></span>
                    </div>
                    <div id="kpiDeposit" class="value">—</div>
                </div>
                <div class="kpi-card" id="kpiWithdrawWrap">
                    <div class="topline">
                        <div class="label">Total Withdraw</div><span class="ico ico-withdraw"><i data-lucide="wallet"></i></span>
                    </div>
                    <div id="kpiWithdraw" class="value">—</div>
                </div>
                <div class="kpi-card" id="kpiNetDepositWrap">
                    <div class="topline">
                        <div class="label">Total Net Deposit</div><span class="ico ico-net"><i data-lucide="move-diagonal-2"></i></span>
                    </div>
                    <div id="kpiNetDeposit" class="value">—</div>
                </div>
                <div class="kpi-card hidden" id="kpiFTDWrap">
                    <div class="topline">
                        <div class="label">FTD Player</div><span class="ico ico-ftd"><i data-lucide="user-plus"></i></span>
                    </div>
                    <div id="kpiFTD" class="value">—</div>
                </div>
                <div class="kpi-card hidden" id="kpiBonusWrap">
                    <div class="topline">
                        <div class="label">Total Bonus</div><span class="ico ico-bonus"><i data-lucide="gift"></i></span>
                    </div>
                    <div id="kpiBonus" class="value">—</div>
                </div>
                <div class="kpi-card hidden" id="kpiTurnoverWrap">
                    <div class="topline">
                        <div class="label">Total Turnover</div><span class="ico ico-turnover"><i data-lucide="repeat"></i></span>
                    </div>
                    <div id="kpiTurnover" class="value">—</div>
                </div>
                <div class="kpi-card" id="kpiCWLWrap">
                    <div class="topline">
                        <div class="label">Company Win/Loss</div><span class="ico ico-cwl"><i data-lucide="badge-dollar-sign"></i></span>
                    </div>
                    <div id="kpiCWL" class="value">—</div>
                </div>
                <div class="kpi-card" id="kpiNetWLWrap">
                    <div class="topline">
                        <div class="label">Net Win/Loss</div><span class="ico ico-netwl"><i data-lucide="scale"></i></span>
                    </div>
                    <div id="kpiNetWL" class="value">—</div>
                </div>
            </div>
        </div>
    </section>
    <!-- Charts -->
    <section class="w-full px-4 mt-4">
        <div class="page grid lg:grid-cols-2 gap-3">
            <div class="card-template p-4" id="cardTrend">
                <div class="inline-loader" id="trendLoader">
                    <div class="dot"></div>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <div class="card-heading"><span class="ico"><i data-lucide="line-chart"></i></span>
                        <h3 id="trendTitle">Monthly Trend</h3>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        <div id="wrapGroupBy" class="select-wrap relative inline-flex items-center hidden">
                            <select id="groupBy" class="select-template pr-8 text-sm bg-transparent focus:outline-none">
                                <option>None</option>
                                <option>Brand Group</option>
                                <option>Brand</option>
                                <option>Currency</option>
                            </select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapPrMetric1" class="select-wrap relative inline-flex items-center hidden">
                            <select id="prMetric1" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapPrMetric2" class="select-wrap relative inline-flex items-center hidden">
                            <select id="prMetric2" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapPrMonth" class="select-wrap relative inline-flex items-center hidden">
                            <select id="prMonth" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapDwMonth" class="select-wrap relative inline-flex items-center hidden">
                            <select id="dwMonth" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapDwMetric1" class="select-wrap relative inline-flex items-center hidden">
                            <select id="dwMetric1" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="wrapDwMetric2" class="select-wrap relative inline-flex items-center hidden">
                            <select id="dwMetric2" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                        <div id="filterBG" class="multi"></div>
                        <div id="filterBrand" class="multi"></div>
                        <div id="filterCurr" class="multi"></div>
                    </div>
                </div>
                <div class="chart-wrap"><canvas id="trend"></canvas></div>
            </div>
            <div class="card-template p-4" id="cardLeader">
                <div class="inline-loader" id="leaderLoader">
                    <div class="dot"></div>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <div class="card-heading"><span class="ico"><i data-lucide="bar-chart-3"></i></span>
                        <h3 id="leaderTitle">Top Brand Groups</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="wrapPrMetricBar" class="select-wrap relative inline-flex items-center hidden">
                            <select id="prMetricBar" class="select-template pr-8 text-sm bg-transparent focus:outline-none"></select>
                            <span class="select-chevron pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-[color:var(--muted)]"><i data-lucide="chevron-down"></i></span>
                        </div>
                    </div>
                </div>
                <div class="chart-wrap"><canvas id="leader"></canvas></div>
            </div>
        </div>
    </section>
    <!-- Table -->
    <section class="w-full px-4 mt-4 mb-10">
        <div class="page">
            <div id="grid-container">
                <div class="inline-loader" id="gridLoader">
                    <div class="dot"></div>
                </div>
                <div id="grid" style="width:100%; height:100%;"></div>
            </div>
        </div>
    </section>
    <!-- ========= Formula Helper Modal ========= -->
    <div id="helperModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="helperTitle">
        <div class="modal-backdrop" data-close="true"></div>
        <div class="modal-panel">
            <div class="modal-head">
                <div class="modal-title"><i data-lucide="help-circle"></i><span id="helperTitle">KPI & Formula Helper</span></div>
                <button class="btn" data-close="true" title="Close"><i data-lucide="x"></i><span class="txt">Close</span></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" style="color:var(--muted)">All formulas compute from the <span class="code-kpi">visible rows</span> and respect the current currency display.</p>
                <div class="formula-list">
                    <div class="formula" style="animation-delay:.00s">
                        <div class="lhs"><span class="ico-formula if-blue"><i data-lucide="move-diagonal-2"></i></span> Net Deposit</div>
                        <div class="rhs"><span class="code-kpi">Net Deposit</span> = <span class="code-kpi">Total Deposit</span> − <span class="code-kpi">Total Withdrawal</span></div>
                    </div>
                    <div class="formula" style="animation-delay:.02s">
                        <div class="lhs"><span class="ico-formula if-amber"><i data-lucide="percent"></i></span> Bonus %</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Bonus</span><span class="bar"></span><span class="den code-kpi">Company Win/Loss</span></span> × 100%</div>
                    </div>
                    <div class="formula" style="animation-delay:.04s">
                        <div class="lhs"><span class="ico-formula if-teal"><i data-lucide="percent"></i></span> Gross Revenue %</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Net Deposit</span><span class="bar"></span><span class="den code-kpi">Total Deposit</span></span> × 100%</div>
                    </div>
                    <div class="formula" style="animation-delay:.06s">
                        <div class="lhs"><span class="ico-formula if-green"><i data-lucide="coins"></i></span> Ave DEP</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Total Deposit</span><span class="bar"></span><span class="den code-kpi">Unique Players</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.08s">
                        <div class="lhs"><span class="ico-formula if-amber"><i data-lucide="gauge"></i></span> Ave WR</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Turnover</span><span class="bar"></span><span class="den code-kpi">Total Deposit</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.10s">
                        <div class="lhs"><span class="ico-formula if-violet"><i data-lucide="repeat"></i></span> Ave Turnover</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Turnover</span><span class="bar"></span><span class="den code-kpi">Unique Players</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.12s">
                        <div class="lhs"><span class="ico-formula if-pink"><i data-lucide="gift"></i></span> Ave Bonus / Player</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Bonus</span><span class="bar"></span><span class="den code-kpi">Unique Players</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.14s">
                        <div class="lhs"><span class="ico-formula if-teal"><i data-lucide="user-check"></i></span> FTD Conversion Rate</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">FTD Players</span><span class="bar"></span><span class="den code-kpi">Sign-up Players</span></span> × 100%</div>
                    </div>
                    <div class="formula" style="animation-delay:.16s">
                        <div class="lhs"><span class="ico-formula if-amber"><i data-lucide="wallet"></i></span> NGR per Player</div>
                        <div class="rhs"><span class="frac"><span class="num"><span class="code-kpi">Company Win/Loss</span> − <span class="code-kpi">Bonus</span></span><span class="bar"></span><span class="den">Unique Players</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.20s">
                        <div class="lhs"><span class="ico-formula if-indigo"><i data-lucide="users"></i></span> Net per Player</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Net Deposit</span><span class="bar"></span><span class="den">Unique Players</span></span></div>
                    </div>
                    <div class="formula" style="animation-delay:.22s">
                        <div class="lhs"><span class="ico-formula if-cyan"><i data-lucide="percent"></i></span> Net Ratio</div>
                        <div class="rhs"><span class="frac"><span class="num code-kpi">Net Deposit</span><span class="bar"></span><span class="den">Total Deposit</span></span> × 100%</div>
                    </div>
                    <div class="formula" style="animation-delay:.24s">
                        <div class="lhs"><span class="ico-formula if-red"><i data-lucide="scale"></i></span> Net Win/Loss</div>
                        <div class="rhs"><span class="code-kpi">Net Win/Loss</span> = <span class="code-kpi">Company Win/Loss</span> − <span class="code-kpi">Bonus</span></div>
                    </div>
                </div>
                <div class="modal-foot"><button class="btn" data-close="true"><i data-lucide="check"></i><span>Got it</span></button></div>
            </div>
        </div>
    </div>
    <!-- ===== Rate Modal with Tabs ===== -->
    <div id="rateModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="rateTitle">
        <div class="modal-backdrop" data-close="true"></div>
        <div class="modal-panel">
            <div class="modal-head">
                <div class="modal-title">
                    <i data-lucide="circle-dollar-sign"></i>
                    <span id="rateTitle">Exchange Rates</span>
                </div>
                <div class="flex gap-2 items-center">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="live"><i data-lucide="zap"></i> Live</button>
                        <button class="tab-btn" data-tab="monthly"><i data-lucide="calendar"></i> Monthly</button>
                    </div>
                    <label class="muted" for="rateMonthSel">Month:</label>
                    <select id="rateMonthSel" class="select-template"></select>
                    <button class="btn" data-close="true">Close</button>
                </div>
            </div>
            <div class="modal-body" id="rateBody">
                <div class="tab-content active" id="tab-live">
                    <div class="fx-wrap">
                        <table class="fx">
                            <thead>
                                <tr>
                                    <th>Currency</th>
                                    <th class="center">Rate (USD)</th>
                                </tr>
                            </thead>
                            <tbody id="liveRatesBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-content" id="tab-monthly">
                    <div class="fx-wrap">
                        <table class="fx">
                            <thead>
                                <tr id="monthlyHeaderRow">
                                    <th>Currency</th>
                                    <!-- month labels injected by JS -->
                                </tr>
                            </thead>
                            <tbody id="monthlyRatesBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-foot">
                    <button class="btn" data-close="true"><i data-lucide="check"></i><span>Done</span></button>
                </div>
            </div>
        </div>
        <!-- Background music (no 'muted') -->
        <audio id="bgMusic" preload="auto" playsinline>
            <source id="bgMusicSrc" src="" type="audio/mpeg">
        </audio>

        <audio id="notificationSound" preload="auto" playsinline>
            <source id="notificationSoundSrc" src="" type="audio/mpeg">
        </audio>

        <audio id="buttonClickSound" preload="auto" playsinline>
            <source id="buttonClickSoundSrc" src="" type="audio/mpeg">
        </audio>

        <audio id="versionSwitchSound" preload="auto" playsinline>
            <source id="versionSwitchSoundSrc" src="" type="audio/mpeg">
        </audio>
        <!-- Volume control slider -->
        <div id="volumeControl" style="position:fixed;bottom:10px;right:10px;">
            <label>Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5"></label>
        </div>
        <!-- ========= /Formula Helper Modal ========= -->
        <script>
            // === Lucide bootstrap helpers ===
            async function ensureLucideReady() {
                // Already present with icons?
                if (window.lucide?.icons && Object.keys(window.lucide.icons).length) return;

                // Inject UMD if it wasn't inserted (defensive)
                if (!document.querySelector('script[data-lucide-umd]')) {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.min.js';
                        s.defer = true;
                        s.setAttribute('data-lucide-umd', '');
                        s.onload = resolve;
                        s.onerror = () => reject(new Error('Lucide UMD failed to load'));
                        document.head.appendChild(s);
                    });
                }

                // Give the browser a tick to attach window.lucide.icons
                await new Promise(r => setTimeout(r, 0));
            }

            function refreshIcons() {
                try {
                    const hasCreate = !!window.lucide?.createIcons;
                    const iconsObj = window.lucide?.icons || {};
                    if (hasCreate && Object.keys(iconsObj).length) {
                        window.lucide.createIcons({
                            nameAttr: 'data-lucide',
                            icons: iconsObj
                        });
                    }
                } catch (err) {
                    console.warn('[icons] refreshIcons failed:', err);
                }
            }

            /* ================== Helpers ================== */
            const colorPalette = ['#ef4444', '#22c55e', '#3b82f6', '#f59e0b', '#8b5cf6', '#14b8a6', '#ec4899', '#6366f1', '#06b6d4', '#a855f7'];
            const fmt = new Intl.NumberFormat(undefined, {
                maximumFractionDigits: 2
            });
            const fmt2 = new Intl.NumberFormat(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const fmt0 = new Intl.NumberFormat(undefined, {
                maximumFractionDigits: 0
            });
            const MONEY = v => (v == null || isNaN(v)) ? '—' : fmt2.format(v);
            const COUNT = v => (v == null || isNaN(v)) ? '—' : fmt0.format(v);
            const headerTooltips = {
                'Net Deposit': 'Total Deposit - Total Withdraw',
                'Net Ratio': '(Net Deposit ÷ Total Deposit) × 100%',
                'Ave WR': 'Turnover ÷ Total Deposit',
                'Ave DEP': 'Total Deposit ÷ Unique Player',
                'Bonus %': '(Bonus ÷ Company Win/Loss) × 100%',
                'Ave Bonus/Player': 'Bonus ÷ Unique Player',
                'Ave Turnover': 'Turnover ÷ Unique Player',
                'Net Win/Loss': 'Company Win/Loss - Bonus',
                'Gross Revenue %': '(Net Deposit ÷ Total Deposit) × 100%',
                'NGR per Player': '(Company Win/Loss - Bonus) ÷ Unique Players',
                'Net per Player': 'Net Deposit ÷ Unique Players',
                'Retention Rate %': '(Unique Players - FTD last month) ÷ Unique Players last month × 100',
                'FTD Conversion Rate': '(FTD Player ÷ SignUp Player) × 100%'
            };
            const percentColumns = new Set(['Bonus %', 'Gross Revenue %', 'Net Ratio', 'Retention Rate %', 'FTD Conversion Rate']);
            const countColumns = new Set(['SignUp Player', 'FTD Player', 'Unique Player']);
            // Pure money fields only (no counts, no percentages, no ratios)
            const currencyColumns = new Set([
                'Total Deposit', 'Total Withdraw', 'Net Deposit', 'Bonus', 'Company Win/Loss', 'Turnover',
                'Ave DEP', 'Ave Turnover', 'Ave Bonus/Player', 'NGR per Player', 'Net per Player', 'Net Win/Loss'
            ]);
            // Ratios (numeric, but NOT currency)
            const ratioColumns = new Set(['Ave WR']);
            const isMonthHeader = h => /^(Jan(uary)?|Feb(ruary)?|Mar(ch)?|Apr(il)?|May|Jun(e)?|Jul(y)?|Aug(ust)?|Sep(t|tember)?|Oct(ober)?|Nov(ember)?|Dec(ember)?)\s\d{4}$/i.test(String(h || ''));

            function hexToRGBA(hex, a = .06) {
                hex = hex.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                const r = parseInt(hex.slice(0, 2), 16),
                    g = parseInt(hex.slice(2, 4), 16),
                    b = parseInt(hex.slice(4, 6), 16);
                return `rgba(${r},${g},${b},${a})`;
            }
            // FORCE a color string to be nearly-opaque (keeps the hue, hides content underneath)
            function forceOpaqueColor(c, alpha = 0.98) {
                c = String(c || '');
                if (c.startsWith('rgba(')) return c.replace(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[^)]+\)/, `rgba($1,$2,$3,${alpha})`);
                if (c.startsWith('rgb(')) return c.replace('rgb(', 'rgba(').replace(')', `,${alpha})`);
                // hex case: convert to rgba with alpha
                if (c.startsWith('#')) {
                    c = c.replace('#', '');
                    if (c.length === 3) c = c.split('').map(x => x + x).join('');
                    const r = parseInt(c.slice(0, 2), 16),
                        g = parseInt(c.slice(2, 4), 16),
                        b = parseInt(c.slice(4, 6), 16);
                    return `rgba(${r},${g},${b},${alpha})`;
                }
                return c;
            }

            function colorForBrandGroup(bg) {
                if (!state.groupColor[bg]) {
                    const idx = Object.keys(state.groupColor).length % colorPalette.length;
                    state.groupColor[bg] = colorPalette[idx];
                }
                return state.groupColor[bg];
            }

            function classifyFormat(headerName, value) {
                if (value == null || value === '') return '—';
                if (percentColumns.has(headerName)) return (Number(value).toFixed(2) + '%');
                if (currencyColumns.has(headerName) || isMonthHeader(headerName)) return MONEY(value);
                if (ratioColumns.has(headerName)) return fmt2.format(value); // ratio, not currency
                if (countColumns.has(headerName)) return COUNT(value);
                if (/^\d+(\.\d+)?$/.test(String(value))) return fmt2.format(value); // generic numeric
                return value;
            }
            const N = v => (v == null || isNaN(v)) ? 0 : +v;
            /* ================== Derived fallbacks ================== */
            function fillDerived(row) {
                row['Net Deposit'] = (row['Net Deposit'] != null) ? row['Net Deposit'] : (N(row['Total Deposit']) - N(row['Total Withdraw']));
                row['Net Win/Loss'] = (row['Net Win/Loss'] != null) ? row['Net Win/Loss'] : (N(row['Company Win/Loss']) - N(row['Bonus']));
                const dep = N(row['Total Deposit']),
                    cwl = N(row['Company Win/Loss']),
                    u = N(row['Unique Player']),
                    to = N(row['Turnover']);
                if (!isNaN(dep) && dep !== 0) {
                    row['Net Ratio'] = row['Net Ratio'] != null ? row['Net Ratio'] : (N(row['Net Deposit']) / dep) * 100;
                    row['Gross Revenue %'] = row['Gross Revenue %'] != null ? row['Gross Revenue %'] : (N(row['Net Deposit']) / dep) * 100;
                    row['Ave WR'] = row['Ave WR'] != null ? row['Ave WR'] : (to / dep);
                }
                if (u) {
                    row['Ave DEP'] = row['Ave DEP'] != null ? row['Ave DEP'] : (dep / u);
                    row['Ave Bonus/Player'] = row['Ave Bonus/Player'] != null ? row['Ave Bonus/Player'] : (N(row['Bonus']) / u);
                    row['Ave Turnover'] = row['Ave Turnover'] != null ? row['Ave Turnover'] : (to / u);
                    row['NGR per Player'] = row['NGR per Player'] != null ? row['NGR per Player'] : ((N(row['Company Win/Loss']) - N(row['Bonus'])) / u);
                    row['Net per Player'] = row['Net per Player'] != null ? row['Net per Player'] : (N(row['Net Deposit']) / u);
                }
                if (cwl) row['Bonus %'] = row['Bonus %'] != null ? row['Bonus %'] : (N(row['Bonus']) / cwl) * 100;
                return row;
            }
            /* ================== State ================== */
            /* ===== Rate Modal: Renderers, Tabs & Live Snapshot ===== */
            async function recordLiveRatesSnapshot() {
                try {
                    const payload = await server.getRates(); // { date, rates:{...} or flat object }
                    const rates = normalizeAndOrientRates_(extractRates(payload));
                    state.fxCache.live = rates;
                    state.liveSnapshot = {
                        date: payload?.date || new Date().toISOString().slice(0, 10),
                        rates
                    };
                    console.info('[FX] Live snapshot recorded:', state.liveSnapshot.date, Object.keys(rates).length, 'ccy');
                } catch (e) {
                    console.warn('[FX] Live snapshot failed:', e);
                }
            }

            function listAllCurrencies() {
                // prefer PR currencies; fallback to DW currencies; always include USD
                const pr = state.raw?.pr?.rows || [];
                const dw = state.raw?.dw?.rows || [];
                const a = new Set(pr.map(r => r.Currency).filter(Boolean));
                dw.forEach(r => a.add(r.Currency));
                a.add('USD');
                return [...a].sort((x, y) => String(x).localeCompare(String(y)));
            }

            function getMonthHeadersForDW() {
                let months = state.raw?.dw?.monthHeaders || [];
                if (!months.length) {
                    // build from PR months if needed
                    const prMonths = [...new Set((state.raw?.pr?.rows || []).map(r => r.Month).filter(Boolean))];
                    months = prMonths;
                }
                // keep display order chronological
                return (months || []).slice().sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
            }
            async function ensureMonthlyRatesCached(monthHeaders) {
                const ymList = (monthHeaders || []).map(monthKey).filter(Boolean);
                if (!ymList.length) return;
                if (!state.fxCache.monthly) state.fxCache.monthly = {};
                const missing = ymList.filter(ym => !state.fxCache.monthly[ym]);
                if (missing.length) {
                    const pack = await server.getMonthlyRates(missing); // {'YYYY-MM':{rates}}
                    Object.keys(pack || {}).forEach(ym => {
                        state.fxCache.monthly[ym] = normalizeAndOrientRates_(extractRates(pack[ym]));
                    });
                    console.info('[FX] Monthly cache filled for:', missing);
                }
            }

            function renderLiveRatesTable() {
                // uses state.fxCache.live (falls back to snapshot or empty)
                const tbody = document.getElementById('liveRatesBody');
                if (!tbody) return;
                const live = state.fxCache?.live || {};
                const all = listAllCurrencies();
                const rows = all.map(ccy => {
                    const rate = (ccy === 'USD') ? 1 : (live[ccy] || null);
                    return `<tr>
      <td><div class="ccy"><span class="flag"></span><span>${ccy}</span></div></td>
      <td class="rate mono">${rate ? fmt2.format(rate) : '—'}</td>
    </tr>`;
                }).join('');
                tbody.innerHTML = rows;
            }
            async function renderMonthlyRatesTable() {
                const thead = document.querySelector('#tab-monthly thead tr');
                const tbody = document.getElementById('monthlyRatesBody');
                if (!thead || !tbody) return;
                // 1) Build header row dynamically (fix: missing month labels)
                const months = getMonthHeadersForDW();
                thead.innerHTML = `<th>Currency</th>${months.map(m => `<th>${esc(m)}</th>`).join('')}`;
                // 2) Ensure monthly cache has all months shown
                await ensureMonthlyRatesCached(months);
                // 3) Render rows for each currency across all months
                const all = listAllCurrencies();
                const rows = all.map(ccy => {
                    const tds = months.map(m => {
                        const ym = monthKey(m);
                        const rr = state.fxCache?.monthly?.[ym] || {};
                        const rate = (ccy === 'USD') ? 1 : rr[ccy];
                        return `<td class="mono">${rate ? fmt2.format(rate) : '—'}</td>`;
                    }).join('');
                    return `<tr>
      <td><div class="ccy"><span class="flag"></span><span>${ccy}</span></div></td>
      ${tds}
    </tr>`;
                }).join('');
                tbody.innerHTML = rows;
            }
            async function openRateModal() {
                // Always have a fresh live snapshot ready for "Live" tab UX
                if (!state.liveSnapshot || !state.fxCache?.live || !Object.keys(state.fxCache.live).length) {
                    await recordLiveRatesSnapshot();
                }
                // Fill the Month selector at the top of modal (mirror DW months)
                const sel = document.getElementById('rateMonthSel');
                if (sel) {
                    const months = getMonthHeadersForDW();
                    sel.innerHTML = months.map(m => `<option>${esc(m)}</option>`).join('');
                    // keep in sync with chosen DW month if any
                    const chosen = (state.dwMonth && state.dwMonth !== 'All') ? state.dwMonth : months.at(-1) || '';
                    if (chosen) sel.value = chosen;
                }
                // Default active tab = 'live' and render
                state.activeRateTab = 'live';
                document.querySelectorAll('#rateModal .tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#rateModal .tab-btn[data-tab="live"]')?.classList.add('active');
                document.querySelectorAll('#rateModal .tab-content').forEach(x => {
                    x.classList.remove('active');
                    if (x.id === 'tab-live') x.classList.add('active');
                });
                renderLiveRatesTable();
                document.getElementById('rateModal')?.classList.add('open');
                refreshIcons();
            }

            function closeRateModal() {
                document.getElementById('rateModal')?.classList.remove('open');
            }

            function wireRateModalEvents() {
                const modal = document.getElementById('rateModal');
                if (!modal || modal.__wired) return;
                modal.__wired = true;
                modal.addEventListener('click', async (e) => {
                    if (e.target.closest('[data-close]')) {
                        closeRateModal();
                        return;
                    }
                    const tabBtn = e.target.closest('.tab-btn');
                    if (tabBtn) {
                        const tab = tabBtn.getAttribute('data-tab');
                        if (!tab || state.activeRateTab === tab) return;
                        state.activeRateTab = tab;
                        modal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        tabBtn.classList.add('active');
                        // animated swap
                        modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        const pane = document.getElementById(`tab-${tab}`);
                        if (tab === 'live') {
                            // refresh live snapshot for most up-to-date view on switch
                            await recordLiveRatesSnapshot();
                            renderLiveRatesTable();
                        } else {
                            await renderMonthlyRatesTable();
                        }
                        pane?.classList.add('active');
                        refreshIcons();
                        return;
                    }
                });
                // Month selector (affects only label row; rates shown are EOM per month columns)
                const sel = document.getElementById('rateMonthSel');
                if (sel) {
                    sel.addEventListener('change', async () => {
                        // The month dropdown is informative for Live; for Monthly it stays as columns.
                        if (state.activeRateTab === 'live') {
                            // optional: could display selected month’s monthly rate next to live; keeping live-only.
                            renderLiveRatesTable();
                        }
                    });
                }
            }

            function wireRateButton() {
                const btn = document.getElementById('rate');
                if (!btn || btn.__wired) return;
                btn.__wired = true;
                btn.addEventListener('click', openRateModal);
            }
            const state = {
                tab: 'pr',
                displayCurrency: 'Original',
                fxCache: {
                    live: {},
                    monthly: {}
                },
                raw: {
                    pr: null,
                    dw: null
                },
                rowsCache: {
                    pr: {
                        original: null,
                        live: null,
                        monthly: null
                    },
                    dw: {
                        original: null,
                        live: null,
                        monthly: null
                    }
                },
                filters: {
                    bg: null,
                    brand: null,
                    curr: null
                },
                data: {},
                collapsedBG: new Set(),
                collapsedBrand: new Set(),
                collapsedCurrency: new Set(),
                seededCurrency: false,
                groupColor: {},
                prTableMonth: 'All',
                dwMonth: 'All',
                quick: '',
                sort: {
                    key: null,
                    dir: 'desc'
                },
                headerFilters: {},
                trendCompare: null,
                dwGroupBy: 'Brand Group',
                activeRateTab: 'live',
                version: 'Current Version'
            };
            /* ================== Charts (theme) ================== */
            function cssVar(name) {
                return getComputedStyle(document.body).getPropertyValue(name).trim()
            }

            function toRGBA(c, a) {
                c = (c || '').trim();
                if (c.startsWith('#')) {
                    let h = c.slice(1);
                    if (h.length === 3) h = h.split('').map(x => x + x).join('');
                    const r = parseInt(h.slice(0, 2), 16),
                        g = parseInt(h.slice(2, 4), 16),
                        b = parseInt(h.slice(4, 6), 16);
                    return `rgba(${r},${g},${b},${a})`;
                }
                if (c.startsWith('rgb(')) return c.replace('rgb(', 'rgba(').replace(')', `,` + a + ')');
                return c;
            }

            function currentChartTheme() {
                const text = cssVar('--text') || '#e8ecf1',
                    line = cssVar('--line') || '#3a414b',
                    panel = cssVar('--panel') || '#2a2f37';
                return {
                    text,
                    grid: toRGBA(line, .35),
                    legend: text,
                    tooltipBg: toRGBA(panel, .95),
                    s1: cssVar('--accent-2') || '#5b9bff',
                    s2: cssVar('--accent') || '#26A69A',
                    s3: cssVar('--warn') || '#f59e0b'
                };
            }

            function baseChartOptions() {
                const t = currentChartTheme();
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 300,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                        axis: 'x'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: t.legend,
                                font: {
                                    weight: 600
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: t.tooltipBg,
                            titleColor: t.text,
                            bodyColor: t.text,
                            borderWidth: 0,
                            itemSort: (a, b) => {
                                const av = (a.parsed?.y ?? a.parsed?.x ?? 0);
                                const bv = (b.parsed?.y ?? b.parsed?.x ?? 0);
                                return bv - av;
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: t.text,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: t.grid
                            }
                        },
                        y: {
                            ticks: {
                                color: t.text,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: t.grid
                            }
                        }
                    }
                };
            }

            function reapplyChartTheme() {
                const opts = baseChartOptions();
                if (trendChart) {
                    trendChart.options = {
                        ...trendChart.options,
                        ...opts,
                        scales: {
                            ...trendChart.options.scales,
                            ...opts.scales
                        },
                        plugins: {
                            ...trendChart.options.plugins,
                            ...opts.plugins
                        }
                    };
                }
                if (leaderChart) {
                    leaderChart.options = {
                        ...leaderChart.options,
                        ...opts,
                        indexAxis: 'y',
                        scales: {
                            ...opts.scales,
                            y: {
                                ...opts.scales.y,
                                ticks: {
                                    ...opts.scales.y.ticks,
                                    autoSkip: false,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            x: {
                                ...opts.scales.x
                            }
                        },
                        plugins: {
                            ...opts.plugins
                        }
                    };
                }
            }

            function applyChartThemeToExisting() {
                [trendChart, leaderChart].forEach(ch => {
                    if (!ch) return;
                    ch.options = {
                        ...ch.options,
                        ...baseChartOptions()
                    };
                    ch.update();
                });
            }
            const hoverRulerPlugin = {
                id: 'hoverRuler',
                afterDatasetsDraw(chart) {
                    const active = chart.tooltip?.getActiveElements?.() || [];
                    if (!active.length) return;
                    const {
                        ctx,
                        chartArea: {
                            top,
                            bottom,
                            left,
                            right
                        }
                    } = chart;
                    const el = active[0].element;
                    const x = el?.x,
                        y = el?.y;
                    if (x == null || y == null) return;
                    const color = getComputedStyle(document.body).getPropertyValue('--line') || '#3a414b';
                    ctx.save();
                    ctx.lineWidth = 1;
                    ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = color;
                    ctx.beginPath();
                    ctx.moveTo(x, top);
                    ctx.lineTo(x, bottom);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(left, y);
                    ctx.lineTo(right, y);
                    ctx.stroke();
                    ctx.restore();
                }
            };
            Chart.register(hoverRulerPlugin);
            /* ================== Charts ================== */
            let trendChart = null,
                leaderChart = null;

            function ensureCharts() {
                const c1 = document.getElementById('trend'),
                    c2 = document.getElementById('leader');
                if (trendChart) {
                    try {
                        trendChart.destroy();
                    } catch {}
                    trendChart = null;
                }
                if (leaderChart) {
                    try {
                        leaderChart.destroy();
                    } catch {}
                    leaderChart = null;
                }
                const opts = baseChartOptions();
                trendChart = new Chart(c1, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: opts
                });
                leaderChart = new Chart(c2, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        ...opts,
                        indexAxis: 'y',
                        maintainAspectRatio: false,
                        scales: {
                            ...opts.scales,
                            y: {
                                ...opts.scales?.y,
                                ticks: {
                                    color: currentChartTheme().text,
                                    autoSkip: false,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            x: {
                                ...opts.scales?.x
                            }
                        }
                    }
                });
            }
            /* ===== Version Engine ===== */
            const VERSION_KEYS = {
                DEFAULT: 'Current Version',
                XMAS: 'Merry Christmas',
                CNY: 'Chinese New Year'
            };
            // Icon swap map (Lucide)
            const ICON_SWAP = {
                [VERSION_KEYS.DEFAULT]: {
                    '#helper i[data-lucide]': 'help-circle',
                    '#refresh i[data-lucide]': 'refresh-cw',
                    '#rate i[data-lucide]': 'circle-dollar-sign',
                    '#themeIcon i[data-lucide]': 'moon-star'
                },
                [VERSION_KEYS.XMAS]: {
                    '#helper i[data-lucide]': 'sparkles',
                    '#refresh i[data-lucide]': 'snowflake',
                    '#rate i[data-lucide]': 'gift',
                    '#themeIcon i[data-lucide]': 'bell'
                },
                [VERSION_KEYS.CNY]: {
                    '#helper i[data-lucide]': 'wand-2',
                    '#refresh i[data-lucide]': 'sparkles',
                    '#rate i[data-lucide]': 'coins',
                    '#themeIcon i[data-lucide]': 'lamp'
                }
            };

            function setBodyThemeClass(version) {
                document.body.classList.remove('theme-christmas', 'theme-chinese-new-year');
                if (version === VERSION_KEYS.XMAS) document.body.classList.add('theme-christmas');
                if (version === VERSION_KEYS.CNY) document.body.classList.add('theme-chinese-new-year');
            }

            function swapIconsForVersion(version) {
                const map = ICON_SWAP[version] || ICON_SWAP[VERSION_KEYS.DEFAULT];
                Object.entries(map).forEach(([sel, name]) => {
                    const el = document.querySelector(sel);
                    if (el) {
                        el.setAttribute('data-lucide', name);
                    }
                });
                refreshIcons();
            }

            function banner(msg, icon = 'sparkles') {
                const box = document.getElementById('versionBanner');
                const txt = document.getElementById('versionBannerText');
                if (!box || !txt) return;
                box.querySelector('i[data-lucide]')?.setAttribute('data-lucide', icon);
                txt.textContent = msg;
                refreshIcons();
                box.classList.add('show');
                setTimeout(() => box.classList.remove('show'), 3000);
            }
            /* ---- Overlays (no external libs) ---- */
            let snowTimer = null,
                fireTimer = null;
            fireworksRAF = null;

            function startSnow() {
                const c = document.getElementById('fx-overlay');
                if (!c) return;
                const ctx = c.getContext('2d');
                const DPR = Math.max(1, window.devicePixelRatio || 1);

                function resize() {
                    c.width = innerWidth * DPR;
                    c.height = innerHeight * DPR;
                }
                resize();
                window.addEventListener('resize', resize);
                const density = document.getElementById('particleDensity').value / 100;
                const flakeCount = Math.floor(100 * density); // Increased slightly for emoji visibility
                const flakes = Array.from({
                    length: flakeCount
                }, () => ({
                    x: Math.random() * c.width,
                    y: Math.random() * c.height,
                    size: 8 + Math.random() * 12, // Larger for emoji
                    s: 0.5 + Math.random() * 1.5,
                    drift: (Math.random() - 0.5) * 0.8,
                    opacity: 0.7 + Math.random() * 0.3,
                    rotation: Math.random() * 360 // Random initial rotation
                }));
                cancelAnimationFrame(snowTimer);
                (function loop() {
                    ctx.clearRect(0, 0, c.width, c.height);
                    flakes.forEach(f => {
                        ctx.save();
                        ctx.translate(f.x, f.y);
                        ctx.rotate(f.rotation * Math.PI / 180); // Rotate for variety
                        ctx.font = `${f.size}px serif`; // Serif for better emoji render
                        ctx.fillStyle = `rgba(255, 255, 255, ${f.opacity})`;
                        ctx.fillText('❄', -f.size / 2, f.size / 2); // Center the emoji
                        ctx.restore();
                        f.y += f.s;
                        f.x += f.drift;
                        f.rotation += 0.5; // Slow spin
                        if (f.y > c.height) {
                            f.y = -f.size;
                            f.x = Math.random() * c.width;
                            f.rotation = Math.random() * 360; // Reset rotation
                        }
                    });
                    snowTimer = requestAnimationFrame(loop);
                })();
            }

            function stopSnow() {
                if (snowTimer) cancelAnimationFrame(snowTimer);
                snowTimer = null;
            }

            function startLanterns() {
                const host = document.getElementById('lanterns');
                if (!host) return;
                host.innerHTML = '';
                const count = 10;
                for (let i = 0; i < count; i++) {
                    const d = document.createElement('div');
                    d.className = 'lantern';
                    const left = Math.random() * 100; // vw
                    const delay = Math.random() * 4;
                    d.style.left = left + 'vw';
                    d.style.animation = `driftV ${18+Math.random()*8}s linear ${delay}s infinite`;
                    d.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="22" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="7" y="3" width="10" height="14" rx="3" ry="3" stroke="gold" />
      <line x1="12" y1="17" x2="12" y2="21" stroke="gold"/>
    </svg>`;
                    d.style.color = 'gold';
                    d.style.animationTimingFunction = 'linear';
                    d.style.willChange = 'transform';
                    host.appendChild(d);
                }
            }

            function stopLanterns() {
                const host = document.getElementById('lanterns');
                if (host) host.innerHTML = '';
            }
            /* ---- Apply Version ---- */
            function startFireworks() {
                // Setup canvas
                const canvas = document.getElementById('fx-overlay');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                // Full screen dimensions with DPR for sharpness
                const DPR = Math.max(1, window.devicePixelRatio || 1);
                let cw = window.innerWidth * DPR;
                let ch = window.innerHeight * DPR;
                canvas.width = cw;
                canvas.height = ch;
                window.addEventListener('resize', () => {
                    cw = window.innerWidth * DPR;
                    ch = window.innerHeight * DPR;
                    canvas.width = cw;
                    canvas.height = ch;
                });

                // Fireworks and particles arrays
                let fireworks = [];
                let particles = [];
                let hue = 120; // Starting hue for color variation
                let limiterTotal = 5; // Limiter for manual launches (not used since auto-only)
                let limiterTick = 0;
                let timerTotal = 80; // Auto-launch interval (lower for more frequent)
                let timerTick = 0;
                let mousedown = false; // Not used (auto-only)
                let mx, my; // Not used

                // Adjust based on particle density slider (0-100 -> scale fireworks frequency and particle count)
                const density = (Number(document.getElementById('particleDensity')?.value) || 50) / 100;
                timerTotal = Math.floor(120 - 80 * density); // More density -> faster launches (40-120 ticks)
                const baseParticleCount = Math.floor(20 + 80 * density); // 20-100 particles per explosion

                // Helper: random in range
                function random(min, max) {
                    return Math.random() * (max - min) + min;
                }

                // Helper: distance between points
                function calculateDistance(p1x, p1y, p2x, p2y) {
                    const xDistance = p1x - p2x;
                    const yDistance = p1y - p2y;
                    return Math.sqrt(Math.pow(xDistance, 2) + Math.pow(yDistance, 2));
                }

                // Firework class (launches upward, explodes at peak)
                function Firework(sx, sy, tx, ty) {
                    this.x = sx;
                    this.y = sy;
                    this.sx = sx;
                    this.sy = sy;
                    this.tx = tx;
                    this.ty = ty;
                    this.distanceToTarget = calculateDistance(sx, sy, tx, ty);
                    this.distanceTraveled = 0;
                    this.coordinates = [];
                    this.coordinateCount = 3; // Trail length
                    while (this.coordinateCount--) {
                        this.coordinates.push([this.x, this.y]);
                    }
                    this.angle = Math.atan2(ty - sy, tx - sx);
                    this.speed = 2;
                    this.acceleration = 1.05;
                    this.brightness = random(50, 70);
                    this.targetRadius = 1;
                }

                Firework.prototype.update = function(index) {
                    this.coordinates.pop();
                    this.coordinates.unshift([this.x, this.y]);
                    if (this.targetRadius < 8) {
                        this.targetRadius += 0.3;
                    } else {
                        this.targetRadius = 1;
                    }
                    this.speed *= this.acceleration;
                    const vx = Math.cos(this.angle) * this.speed;
                    const vy = Math.sin(this.angle) * this.speed;
                    this.distanceTraveled = calculateDistance(this.sx, this.sy, this.x + vx, this.y + vy);
                    if (this.distanceTraveled >= this.distanceToTarget) {
                        createParticles(this.tx, this.ty);
                        fireworks.splice(index, 1);
                    } else {
                        this.x += vx;
                        this.y += vy;
                    }
                };

                Firework.prototype.draw = function() {
                    ctx.beginPath();
                    ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                    ctx.lineTo(this.x, this.y);
                    ctx.strokeStyle = 'hsl(' + hue + ', 100%, ' + this.brightness + '%)';
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2);
                    ctx.stroke();
                };

                // Particle class (explosion sparks with trails and fade)
                function Particle(x, y) {
                    this.x = x;
                    this.y = y;
                    this.coordinates = [];
                    this.coordinateCount = 5; // Longer trails for realism
                    while (this.coordinateCount--) {
                        this.coordinates.push([this.x, this.y]);
                    }
                    this.angle = random(0, Math.PI * 2);
                    this.speed = random(1, 10);
                    this.friction = 0.95; // Slow down over time
                    this.gravity = 1; // Pull down
                    this.hue = random(hue - 50, hue + 50);
                    this.brightness = random(50, 80);
                    this.alpha = 1;
                    this.decay = random(0.015, 0.03); // Fade rate
                }

                Particle.prototype.update = function(index) {
                    this.coordinates.pop();
                    this.coordinates.unshift([this.x, this.y]);
                    this.speed *= this.friction;
                    this.x += Math.cos(this.angle) * this.speed;
                    this.y += Math.sin(this.angle) * this.speed + this.gravity;
                    this.alpha -= this.decay;
                    if (this.alpha <= this.decay) {
                        particles.splice(index, 1);
                    }
                };

                Particle.prototype.draw = function() {
                    ctx.beginPath();
                    ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                    ctx.lineTo(this.x, this.y);
                    ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')';
                    ctx.stroke();
                };

                // Create explosion particles
                function createParticles(x, y) {
                    let particleCount = baseParticleCount; // Adjusted by density
                    while (particleCount--) {
                        particles.push(new Particle(x, y));
                    }
                }

                // Main animation loop
                function loop() {
                    requestAnimationFrame(loop);
                    hue += 0.5; // Cycle colors over time
                    // Trail effect: semi-clear instead of full clear
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, cw, ch);
                    ctx.globalCompositeOperation = 'lighter';
                    // Update/draw fireworks
                    let i = fireworks.length;
                    while (i--) {
                        fireworks[i].draw();
                        fireworks[i].update(i);
                    }
                    // Update/draw particles
                    i = particles.length;
                    while (i--) {
                        particles[i].draw();
                        particles[i].update(i);
                    }
                    // Auto-launch fireworks
                    if (timerTick >= timerTotal) {
                        fireworks.push(new Firework(cw / 2, ch, random(0, cw), random(0, ch / 2))); // Launch from bottom center to random upper target
                        timerTick = 0;
                    } else {
                        timerTick++;
                    }
                }

                // Start the loop
                loop();
            }

            function stopFireworks() {
                if (fireTimer) clearInterval(fireTimer);
                fireTimer = null;
                if (fireworksRAF) cancelAnimationFrame(fireworksRAF);
                fireworksRAF = null;
            }


            function applyVersion(version) {
                state.version = version;
                destroyTheme();
                setBodyThemeClass(version);
                swapIconsForVersion(version);

                // Always set sources for this version
                setSoundSourcesForVersion(version);

                // Ensure iframe autoplay is unlocked once
                primeAudioAfterGesture();

                // Visual overlays/banners reset
                stopSnow();
                stopLanterns();

                const bannerEl = document.getElementById('welcomeBanner');
                const welcomeText = document.getElementById('welcomeText');

                if (version === VERSION_KEYS.XMAS) {
                    startSnow();
                    banner('Merry Christmas Theme', 'snowflake');
                    if (bannerEl) bannerEl.style.display = 'flex';
                    if (welcomeText) welcomeText.textContent = 'Merry Christmas';

                    // icons...
                    const iconsHost = document.getElementById('welcomeIcons');
                    if (iconsHost) {
                        iconsHost.innerHTML = `
        <svg class="welcome-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2L4 18h16L12 2z" fill="var(--accent)" stroke="var(--text)"/>
          <rect x="10.5" y="18" width="3" height="3" fill="var(--text)"/>
        </svg>
        <i data-lucide="gift"></i>
      `;
                        refreshIcons();
                    }

                    // play stinger + bg (loop)
                    tryPlay('versionSwitchSound');
                    tryPlay('bgMusic', true);

                    startCountdown();
                    addTreeWidget();
                    updateGreeting();

                } else if (version === VERSION_KEYS.CNY) {
                    startLanterns();
                    banner('Chinese New Year Theme', 'coins');
                    if (bannerEl) bannerEl.style.display = 'flex';
                    if (welcomeText) welcomeText.textContent = 'Happy Lunar New Year';

                    // icons...
                    const iconsHost = document.getElementById('welcomeIcons');
                    if (iconsHost) {
                        iconsHost.innerHTML = `
        <i data-lucide="coins"></i>
        <i data-lucide="lamp"></i>
        <svg class="welcome-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="6" fill="orange"/>
          <line x1="12" y1="18" x2="12" y2="22" stroke="orange"/>
        </svg>
      `;
                        refreshIcons();
                    }

                    // play stinger + bg (loop)
                    tryPlay('versionSwitchSound');
                    tryPlay('bgMusic', true);

                    showFortuneMessage();
                    addCoinSpin();
                    startFireworks();

                    const notification = document.getElementById('versionNotification');
                    if (notification) notification.classList.add('fortune');

                } else {
                    if (bannerEl) bannerEl.style.display = 'none';
                    // Pause background when not in festive theme
                    const bg = document.getElementById('bgMusic');
                    if (bg) bg.pause();
                }

                // Reset particle density UI
                document.getElementById('particleDensity').value = 50;
                adjustParticleDensity(50);

                // Refresh charts (unchanged from your code)
                reapplyChartTheme?.();
                trendChart?.update?.();
                leaderChart?.update?.();
            }

            function destroyTheme() {
                // Reset animations, particles, sounds
                stopSnow();
                stopLanterns();
                stopFireworks(); // ← ensure fireworks are stopped too
                const bg = document.getElementById('bgMusic');
                if (bg) bg.pause();
                document.querySelectorAll('.animated').forEach(el => el.classList.remove('animated'));
            }


            // Wire sound triggers (notifications, clicks, hovers, tabs) with error handling
            // Play on ANY buttons/tabs while in XMAS or CNY versions
            document.addEventListener('click', e => {
                const clickable = e.target.closest(
                    'button, [role="button"], .btn, .btn-template, .tab, .tab-btn, a[href], .nav-item, .controls button'
                );
                if (clickable && (state.version === VERSION_KEYS.XMAS || state.version === VERSION_KEYS.CNY)) {
                    tryPlay('buttonClickSound');
                }
            });

            // Keep your notification hover sound
            document.addEventListener('mouseover', e => {
                if (e.target.closest('.notification')) {
                    tryPlay('notificationSound');
                }
            });

            // Tab change
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    tryPlay('buttonClickSound');
                });
            });

            // Volume slider
            const getVol = () => {
                const v = Number(document.getElementById('volumeSlider')?.value ?? 50);
                return Math.min(1, Math.max(0, v > 1 ? v / 100 : v)); // handles 0–1 or 0–100
            };

            document.getElementById('volumeSlider')?.addEventListener('input', e => {
                const vol = getVol();
                ['bgMusic', 'notificationSound', 'buttonClickSound', 'versionSwitchSound']
                .forEach(id => {
                    const a = document.getElementById(id);
                    if (a) a.volume = vol;
                });
            });

            function tryPlay(id, loop = false) {
                const a = document.getElementById(id);
                if (!a) return;
                a.loop = !!loop;
                a.volume = getVol();
                const p = a.play();
                if (p?.catch) p.catch(() => {});
            }

            // NEW: call once during init to “unlock” audio in iframes (GAS web app)
            function primeAudioAfterGesture() {
                if (primeAudioAfterGesture._done) return;
                const unlock = () => {
                    ['bgMusic', 'notificationSound', 'buttonClickSound', 'versionSwitchSound'].forEach(id => {
                        const a = document.getElementById(id);
                        if (a) {
                            a.play().then(() => a.pause()).catch(() => {});
                        }
                    });
                    if (window.AudioContext) {
                        try {
                            new AudioContext().resume();
                        } catch {}
                    }
                    primeAudioAfterGesture._done = true;
                    document.removeEventListener('pointerdown', unlock, {
                        capture: true
                    });
                };
                document.addEventListener('pointerdown', unlock, {
                    once: true,
                    capture: true
                });
            }
            // === Per-version sound mapping (click & version-switch) ===
            function setSoundSourcesForVersion(version) {
                const base = 'https://raw.githubusercontent.com/BA-SupportII/Insight/main/';

                const table = {
                    'Merry Christmas': {
                        click: base + 'jingle-bells-107671.mp3',
                        switch: base + 'sound-effect-jingle-bells-jingle-bells-music-box-269306.mp3',
                        bg: base + 'jingle-bells-107671.mp3',
                        notif: base + 'sound-effect-jingle-bells-jingle-bells-music-box-269306.mp3'
                    },
                    'Chinese New Year': {
                        click: base + 'fireworks-07-419025.mp3',
                        switch: base + 'chinese-ident-transition-1-283708.mp3',
                        bg: base + 'chinese-ident-transition-1-283708.mp3',
                        notif: base + 'fireworks-07-419025.mp3'
                    },
                    'Current Version': {
                        click: '',
                        switch: '',
                        bg: '',
                        notif: ''
                    }
                };

                const cfg = table[version] || table['Current Version'];
                [
                    ['buttonClickSoundSrc', 'buttonClickSound', cfg.click],
                    ['notificationSoundSrc', 'notificationSound', cfg.notif],
                    ['versionSwitchSoundSrc', 'versionSwitchSound', cfg.switch],
                    ['bgMusicSrc', 'bgMusic', cfg.bg],
                ].forEach(([srcId, audioId, url]) => {
                    const srcEl = document.getElementById(srcId);
                    const audio = document.getElementById(audioId);
                    if (srcEl && audio) {
                        srcEl.src = url || '';
                        audio.load();
                    }
                });
            }

            // Particle Density
            function adjustParticleDensity(density) {
                // Adjust flake/lantern count based on density (0-100)
                // e.g., flakes.length = 80 * (density / 100);
                // Then restart snow/lanterns
                if (state.version === VERSION_KEYS.XMAS) {
                    stopSnow();
                    startSnow();
                }
                if (state.version === VERSION_KEYS.CNY) {
                    stopLanterns();
                    startLanterns();
                    stopFireworks();
                    startFireworks(); // reflect new density in bursts
                }
            }
            document.getElementById('particleDensity')?.addEventListener('change', e => adjustParticleDensity(e.target.value));

            // Keyboard Navigation
            document.addEventListener('keydown', e => {
                if (e.key === 'Tab') {
                    // Focus next button/modal/tab
                    const focusable = [...document.querySelectorAll('button, select, input, [tabindex]:not([tabindex="-1"])')];
                    const idx = focusable.indexOf(document.activeElement);
                    const next = focusable[idx + (e.shiftKey ? -1 : 1)] || focusable[0];
                    next.focus();
                    e.preventDefault();
                }
            });

            // Additional Features for Christmas
            function startCountdown() {
                const target = new Date('December 25, 2025');
                const timer = document.createElement('div');
                timer.id = 'christmasCountdown';
                timer.style.position = 'fixed';
                timer.style.top = '10px';
                timer.style.left = '50%';
                timer.style.transform = 'translateX(-50%)';
                timer.innerHTML = 'Days to Christmas: calculating...';
                document.body.appendChild(timer);
                setInterval(() => {
                    const now = new Date();
                    const diff = target - now;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    timer.innerHTML = `Days to Christmas: ${days}`;
                }, 1000);
            }

            function addTreeWidget() {
                const tree = document.createElement('svg');
                tree.className = 'icon-christmas-tree';
                tree.addEventListener('click', () => {
                    tree.style.animation = 'pulse 1s';
                    tryPlay('notificationSound');
                });
                // Add to header or KPI
                document.getElementById('kpis').appendChild(tree);
            }

            function updateGreeting() {
                const now = new Date();
                const text = now.getDate() === 24 ? 'Christmas Eve' : (now.getDate() === 25 ? 'Merry Christmas' : 'Happy Holidays');
                document.getElementById('welcomeText').textContent = text;
            }

            function showFortuneMessage() {
                const fortunes = ['Good luck!', 'Prosperity ahead!'];
                const message = fortunes[Math.floor(Math.random() * fortunes.length)];
                const notification = document.getElementById('versionNotification');
                if (notification) {
                    const notificationText = document.getElementById('notificationText');
                    if (notificationText) notificationText.textContent = message;
                    notification.classList.add('show');
                    notification.style.display = 'flex';
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.style.display = 'none', 500);
                    }, 3000);
                    tryPlay('notificationSound'); // ← fix
                }
            }

            function addCoinSpin() {
                const coin = document.createElement('svg');
                coin.className = 'icon-red-envelope';
                coin.addEventListener('click', () => {
                    coin.style.animation = 'spin 1s';
                    tryPlay('buttonClickSound');
                });
                // Add to dashboard
                document.getElementById('kpis').appendChild(coin);
            }
            /* ================== Server wrappers ================== */
            const server = {
                fetchPRMonthly: (filters) => new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).fetchPRMonthly(filters)),
                fetchDepositWithdraw: (filters) => new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).fetchDepositWithdraw(filters)),
                getRates: () => new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getRates('USD')),
                getMonthlyRates: (months) => new Promise((res) =>
                    google.script.run.withSuccessHandler(res)
                    .withFailureHandler(err => {
                        console.warn('[FX] monthly batch error:', err);
                        res({});
                    })
                    .getMonthlyRates(months))
            };
            /* ================== Data prefetch & FX conversion ================== */
            async function prefetchAll() {
                const [prRes, dwRes] = await Promise.all([server.fetchPRMonthly({}), server.fetchDepositWithdraw({})]);
                state.raw.pr = {
                    headers: prRes.headers || [],
                    rows: (prRes.rows || []).map(fillDerived)
                };
                const baseHeaders = (dwRes.headers || []).filter(h => !isMonthHeader(h));
                let months = (dwRes.monthHeaders && dwRes.monthHeaders.length) ? dwRes.monthHeaders : (dwRes.headers || []).filter(isMonthHeader);
                if (!months.length) months = [];
                const headers = baseHeaders.concat(months);
                state.raw.dw = {
                    headers,
                    rows: dwRes.rows || [],
                    monthHeaders: months
                };
                state.rowsCache.pr = {
                    original: null,
                    live: null,
                    monthly: null
                };
                state.rowsCache.dw = {
                    original: null,
                    live: null,
                    monthly: null
                };
            }
            const deepCopy = x => JSON.parse(JSON.stringify(x));
            const currencyModeKey = (mode) => {
                const v = String(mode || document.getElementById('currency')?.value || 'Original').toLowerCase().replace(/\s+/g, '');
                if (v.includes('usd') && v.includes('live')) return 'live';
                if (v.includes('usd') && (v.includes('monthlyrate') || v.includes('monthly'))) return 'monthly';
                return 'original';
            };
            // More robust: accepts "September 2025", "Sept 2025", "2025-09", "2025/09", "202509"
            function monthLabelToYM(label) {
                if (!label) return null;
                const s = String(label).trim();
                // 1) Already like YYYY-MM or YYYY/MM
                let m = s.match(/^(\d{4})[-\/](\d{1,2})$/);
                if (m) return `${m[1]}-${String(m[2]).padStart(2,'0')}`;
                // 2) "MonthName YYYY" (e.g., Sep 2025)
                const MONTHS = {
                    january: 1,
                    february: 2,
                    march: 3,
                    april: 4,
                    may: 5,
                    june: 6,
                    july: 7,
                    august: 8,
                    september: 9,
                    october: 10,
                    november: 11,
                    december: 12,
                    jan: 1,
                    feb: 2,
                    mar: 3,
                    apr: 4,
                    may_: 5,
                    jun: 6,
                    jul: 7,
                    aug: 8,
                    sep: 9,
                    sept: 9,
                    oct: 10,
                    nov: 11,
                    dec: 12
                };
                m = s.match(/^([A-Za-z\.]+)\s+(\d{4})$/);
                if (m) {
                    let name = m[1].toLowerCase().replace(/\./g, '');
                    if (name === 'may') name = 'may_';
                    const num = MONTHS[name];
                    if (num) return `${m[2]}-${String(num).padStart(2,'0')}`;
                }
                // 3) "YYYY MonthName"
                m = s.match(/^(\d{4})\s+([A-Za-z\.]+)$/);
                if (m) {
                    let name = m[2].toLowerCase().replace(/\./g, '');
                    if (name === 'may') name = 'may_';
                    const num = MONTHS[name];
                    if (num) return `${m[1]}-${String(num).padStart(2,'0')}`;
                }
                // 4) "YYYYMM"
                m = s.match(/^(\d{4})(\d{2})$/);
                if (m) return `${m[1]}-${m[2]}`;
                // 5) Fallback to Date parser ("1 " + label)
                const d = new Date('1 ' + s);
                if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                return null;
            }
            // Keep the original name for the rest of the code
            const monthKey = monthLabelToYM;
            const extractRates = payload => (payload && payload.rates) ? payload.rates : (payload || {});

            function normalizeAndOrientRates_(rates) {
                const up = {};
                Object.keys(rates || {}).forEach(k => {
                    const v = Number(rates[k]);
                    if (isFinite(v) && v > 0) up[String(k).toUpperCase()] = v;
                });
                if (!up.USD) up.USD = 1;
                const anchors = {
                    VND: 20000,
                    IDR: 10000,
                    BDT: 50,
                    PKR: 50,
                    LKR: 150,
                    MMK: 500,
                    KRW: 800
                };
                let seen = 0,
                    bad = 0;
                for (const [ccy, min] of Object.entries(anchors)) {
                    if (up[ccy] != null) {
                        seen++;
                        if (up[ccy] < 1) bad++;
                    }
                }
                if (seen && (bad / seen) > 0.6) {
                    const inv = {};
                    Object.keys(up).forEach(k => inv[k] = up[k] ? 1 / up[k] : up[k]);
                    inv.USD = 1;
                    return inv;
                }
                return up;
            }
            // CACHED, VERBOSE version (logs each conversion) -----------------------------
            async function convertRowsInPlace(rows, mode, monthHeaders = null) {
                const display = String(mode || document.getElementById('currency')?.value || 'Original').trim();
                if (!rows?.length || display === 'Original') return;
                const log = (...a) => console.log('[FX]', ...a);
                const warn = (...a) => console.warn('[FX]', ...a);
                const cleanCode = c => {
                    c = String(c || '').trim().toUpperCase();
                    if (c === 'USDT' || c === 'USD$') return 'USD';
                    return c;
                };
                const isLive = /USD/i.test(display) && /LIVE/i.test(display);
                const isMonthly = /USD/i.test(display) && /MONTHLY/i.test(display);
                let changed = 0;
                const mutateMoney = (obj, key, rate) => {
                    const v = Number(obj[key]);
                    if (isFinite(v)) {
                        obj[key] = v / rate; // CCY-per-USD → divide to get USD
                        changed++;
                        return true;
                    }
                    return false;
                };
                // -------------------- LIVE (always fresh) --------------------
                if (isLive) {
                    // Always fetch a fresh snapshot (do not rely on cached state.fxCache.live)
                    const payload = await server.getRates();
                    const rr = normalizeAndOrientRates_(extractRates(payload));
                    state.fxCache.live = rr; // keep for inspection/logging only
                    log('LIVE rates fetched (fresh).', {
                        date: payload?.date,
                        keys: Object.keys(rr).length
                    });
                    for (const row of rows) {
                        const c = cleanCode(row['Currency']);
                        const rate = (c === 'USD') ? 1 : Number(rr[c]);
                        if (!rate) {
                            warn('LIVE missing rate', {
                                c
                            });
                            continue;
                        }
                        if (monthHeaders?.length) {
                            let local = 0;
                            for (const mh of monthHeaders)
                                if (mutateMoney(row, mh, rate)) local++;
                            if (local) log('LIVE convert', {
                                currency: c,
                                months: local,
                                rate
                            });
                        } else {
                            let local = 0;
                            for (const h of Object.keys(row))
                                if (currencyColumns.has(h))
                                    if (mutateMoney(row, h, rate)) local++;
                            if (local) log('LIVE convert row', {
                                currency: c,
                                fields: local,
                                rate,
                                month: row.Month
                            });
                        }
                    }
                }
                // -------------------- MONTHLY (cache per-month) --------------------
                if (isMonthly) {
                    // Which months are actually needed?
                    const monthsNeeded = monthHeaders?.length ? [...new Set(monthHeaders.map(monthKey))] // DW: headers → 'YYYY-MM'
                        :
                        [...new Set(rows.map(r => r.Month).filter(Boolean).map(monthKey))]; // PR: row.Month → 'YYYY-MM'
                    // ensure cache bucket
                    if (!state.fxCache.monthly) state.fxCache.monthly = {};
                    // fetch only the missing months, then cache
                    const missing = monthsNeeded.filter(ym => !state.fxCache.monthly[ym]);
                    if (missing.length) {
                        const pack = await server.getMonthlyRates(missing); // { 'YYYY-MM': {rates...} }
                        Object.keys(pack || {}).forEach(ym => {
                            state.fxCache.monthly[ym] = normalizeAndOrientRates_(extractRates(pack[ym]));
                            log('MONTHLY rates cached', {
                                ym,
                                keys: Object.keys(state.fxCache.monthly[ym] || {}).length
                            });
                        });
                    } else {
                        log('MONTHLY rates: using cached values for all months.', {
                            months: monthsNeeded
                        });
                    }
                    if (monthHeaders?.length) {
                        // D&W: each column belongs to a month
                        for (const row of rows) {
                            const c = cleanCode(row['Currency']);
                            let local = 0;
                            for (const mh of monthHeaders) {
                                const ym = monthKey(mh);
                                const rr = state.fxCache.monthly[ym] || {};
                                const rate = (c === 'USD') ? 1 : Number(rr[c]);
                                if (!rate) {
                                    warn('MONTHLY missing rate', {
                                        ym,
                                        c
                                    });
                                    continue;
                                }
                                if (mutateMoney(row, mh, rate)) local++;
                            }
                            if (local) log('MONTHLY convert (DW row)', {
                                currency: c,
                                months: local
                            });
                        }
                    } else {
                        // PR: row.Month drives which month’s rate to use
                        for (const row of rows) {
                            const c = cleanCode(row['Currency']);
                            const ym = monthKey(row.Month);
                            const rr = state.fxCache.monthly[ym] || {};
                            const rate = (c === 'USD') ? 1 : Number(rr[c]);
                            if (!rate) {
                                warn('MONTHLY missing rate', {
                                    ym,
                                    c
                                });
                                continue;
                            }
                            let local = 0;
                            for (const h of Object.keys(row))
                                if (currencyColumns.has(h))
                                    if (mutateMoney(row, h, rate)) local++;
                            if (local) log('MONTHLY convert (PR row)', {
                                month: ym,
                                currency: c,
                                fields: local,
                                rate
                            });
                        }
                    }
                }
                // If there were non-USD currencies but nothing changed, signal failure so caller can fall back.
                const hadNonUsd = rows.some(r => cleanCode(r['Currency']) !== 'USD');
                if (hadNonUsd && changed === 0) {
                    throw new Error('FX conversion produced 0 changes (missing rates or provider unavailable).');
                }
            }
            // Use row caches if we already built this mode; FX fetches are cached inside convertRowsInPlace
            async function buildCachesForMode(mode) {
                const key = currencyModeKey(mode);
                // seed originals once
                if (!state.rowsCache.pr.original && state.raw.pr) {
                    state.rowsCache.pr.original = deepCopy(state.raw.pr.rows);
                }
                if (!state.rowsCache.dw.original && state.raw.dw) {
                    state.rowsCache.dw.original = deepCopy(state.raw.dw.rows);
                }
                // Reuse cache for everything EXCEPT 'live' (force fresh rates & reconvert)
                const canReuseConverted =
                    key !== 'live' && state.rowsCache.pr[key] && state.rowsCache.dw[key];
                if (canReuseConverted) {
                    console.info('[CACHE] Using previously converted rows for', key);
                    return;
                }
                // (Re)build this mode now; convertRowsInPlace will log + pull FX from cache when possible
                if (key === 'original') {
                    state.rowsCache.pr.original = state.rowsCache.pr.original || deepCopy(state.raw.pr.rows);
                    state.rowsCache.dw.original = state.rowsCache.dw.original || deepCopy(state.raw.dw.rows);
                    return;
                }
                const prRows = deepCopy(state.raw.pr.rows);
                try {
                    await convertRowsInPlace(prRows, mode, null);
                    state.rowsCache.pr[key] = prRows.map(fillDerived);
                } catch (e) {
                    console.warn('PR conversion failed → using Original:', e);
                    state.rowsCache.pr[key] = deepCopy(state.rowsCache.pr.original);
                }
                const dwRows = deepCopy(state.raw.dw.rows);
                try {
                    await convertRowsInPlace(dwRows, mode, state.raw.dw.monthHeaders || []);
                    state.rowsCache.dw[key] = dwRows;
                } catch (e) {
                    console.warn('DW conversion failed → using Original:', e);
                    state.rowsCache.dw[key] = deepCopy(state.rowsCache.dw.original);
                }
            }
            /* ================== Select helpers ================== */
            function enhanceSelect(id) {
                const sel = document.getElementById(id);
                if (!sel) return;
                const wrap = sel.closest('.select-wrap');
                if (!wrap) return;
                sel.addEventListener('focus', () => wrap.classList.add('open'));
                sel.addEventListener('blur', () => wrap.classList.remove('open'));
            }
            ['currency', 'dwMonth', 'prMetric1', 'prMetric2', 'prMetricBar', 'dwMetric1', 'dwMetric2', 'prMonth', 'groupBy'].forEach(enhanceSelect);

            function selectedPrMetric(id) {
                const el = document.getElementById(id);
                return (el && !el.classList.contains('hidden')) ? el.value : null;
            }

            function setSelectVisible(wrapId, on) {
                const wrap = document.getElementById(wrapId);
                if (!wrap) return;
                wrap.classList.toggle('hidden', !on);
            }

            function fillSelect(id, options, value) {
                const sel = document.getElementById(id);
                if (!sel) return;
                sel.innerHTML = options.map(o => `<option>${o}</option>`).join('');
                sel.value = (value && options.includes(value)) ? value : options[0];
            }
            /* ================== Filters UI (multi-select popovers) ================== */
            function distinct(rows, key) {
                return [...new Set(rows.map(r => String(r[key] || '')).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            }

            function renderMulti(containerId, label, icon, items, selectedSet) {
                const root = document.getElementById(containerId);
                if (!root) return;
                const map = {
                    filterBG: 'bg',
                    gridFilterBG: 'bg',
                    filterBrand: 'brand',
                    gridFilterBrand: 'brand',
                    filterCurr: 'curr',
                    gridFilterCurr: 'curr',
                    // NEW: special case for trend comparison (doesn't change table filters)
                    trendCompare: 'trendCompare'
                };
                const which = map[containerId];
                // ---- persist a stable "universe" of options for this control
                if (!state.multiUniverse) state.multiUniverse = {};
                if (Array.isArray(items) && items.length && !state.multiUniverse[containerId]) {
                    state.multiUniverse[containerId] = [...new Set(items)]
                        .sort((a, b) => String(a).localeCompare(String(b)));
                }
                const allItems = state.multiUniverse[containerId] || [];
                // selectedSet semantics:
                // null => "All" (no filter) -> every box checked
                // empty Set => "None" (show nothing) -> every box unchecked (but list visible)
                // Set(values)=> those values checked
                const mode = (selectedSet === null) ?
                    'ALL' :
                    (selectedSet && selectedSet.size === 0 ? 'NONE' : 'SOME');
                root.innerHTML = `
    <button class="btn-template multi-btn" type="button" aria-expanded="false">
      <i data-lucide="${icon}"></i><span class="txt">${label}</span>
    </button>
    <div class="multi-pop">
      <div class="multi-scroll">
        ${allItems.map(v => {
          const checked = (mode === 'ALL') ? true : (selectedSet?.has(v) || false);
          return `<label class="multi-item">
                    <input type="checkbox" value="${esc(v)}" ${checked ? 'checked':''}/>
                    <span>${esc(v)}</span>
                  </label>`;
        }).join('')}
      </div>
      <div class="multi-actions">
        <button class="btn-template" data-act="toggle-all" type="button">Select All</button>
        <button class="btn-template" data-act="close" type="button">Close</button>
      </div>
    </div>`;
                const btn = root.querySelector('.multi-btn');
                const toggleAllBtn = root.querySelector('[data-act="toggle-all"]');

                function currentCheckboxes() {
                    return [...root.querySelectorAll('input[type="checkbox"]')];
                }

                function updateToggleAllLabel() {
                    const cbs = currentCheckboxes();
                    const isAll = cbs.length && cbs.every(cb => cb.checked);
                    toggleAllBtn.textContent = isAll ? 'Deselect All' : 'Select All';
                }

                function pushToStateFromUI() {
                    const picked = new Set(currentCheckboxes().filter(x => x.checked).map(x => x.value));
                    const normalized = (picked.size === allItems.length) ? null : picked;
                    if (which === 'bg') state.filters.bg = normalized;
                    else if (which === 'brand') state.filters.brand = normalized;
                    else if (which === 'curr') state.filters.curr = normalized;
                    else if (which === 'trendCompare') state.trendCompare = normalized; // NEW
                }

                function rebuildAndKeepOpen() {
                    state.openMultiId = containerId;
                    // NEW: Compare only updates charts (tables unchanged)
                    if (which === 'trendCompare') chartRefreshFromCurrent();
                    else rebuildTableForCurrent();
                }
                // open/close
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const open = root.classList.toggle('open');
                    btn.setAttribute('aria-expanded', String(open));
                    state.openMultiId = open ? containerId : null;
                    refreshIcons();
                    updateToggleAllLabel();
                });
                // checkbox change
                root.querySelector('.multi-scroll').addEventListener('change', (e) => {
                    if (e.target.type !== 'checkbox') return;
                    e.stopPropagation();
                    updateToggleAllLabel();
                    pushToStateFromUI();
                    rebuildAndKeepOpen(); // <— re-render table BUT keep this popover open
                });
                // actions
                root.addEventListener('click', (e) => {
                    const act = e.target.closest('[data-act]')?.getAttribute('data-act');
                    if (!act) return;
                    e.preventDefault();
                    e.stopPropagation();
                    if (act === 'toggle-all') {
                        const cbs = currentCheckboxes();
                        const isAll = cbs.length && cbs.every(cb => cb.checked);
                        cbs.forEach(cb => cb.checked = !isAll); // Select All → check; Deselect All → uncheck
                        updateToggleAllLabel();
                        pushToStateFromUI();
                        rebuildAndKeepOpen(); // <— keep it open after rebuild
                        return;
                    }
                    if (act === 'close') {
                        root.classList.remove('open');
                        btn.setAttribute('aria-expanded', 'false');
                        if (state.openMultiId === containerId) state.openMultiId = null;
                        return;
                    }
                });
                // outside click (auto-remove listener if this root is detached)
                const onDocClick = (e) => {
                    if (!root.isConnected) {
                        document.removeEventListener('click', onDocClick);
                        return;
                    }
                    if (!root.contains(e.target)) {
                        root.classList.remove('open');
                        btn.setAttribute('aria-expanded', 'false');
                        if (state.openMultiId === containerId) state.openMultiId = null;
                    }
                };
                document.addEventListener('click', onDocClick);
                // if this was open before rebuild, reopen now
                if (state.openMultiId === containerId) {
                    root.classList.add('open');
                    btn.setAttribute('aria-expanded', 'true');
                }
                refreshIcons();
                updateToggleAllLabel();
            }
            /* ================== KPI updaters ================== */
            function updateKPIs_PR(rows) {
                const sum = k => rows.reduce((a, r) => a + (+r[k] || 0), 0);
                const deposit = sum('Total Deposit'),
                    withdraw = sum('Total Withdraw'),
                    netDep = sum('Net Deposit');
                const cwl = sum('Company Win/Loss'),
                    netWL = sum('Net Win/Loss'),
                    ftd = sum('FTD Player'),
                    bonus = sum('Bonus'),
                    turnover = sum('Turnover');
                const set = (id, v, isCount = false) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = isCount ? COUNT(v) : MONEY(v);
                };
                set('kpiDeposit', deposit);
                set('kpiWithdraw', withdraw);
                set('kpiNetDeposit', netDep);
                set('kpiCWL', cwl);
                set('kpiNetWL', netWL);
                set('kpiFTD', ftd, true);
                set('kpiBonus', bonus);
                set('kpiTurnover', turnover);
                ['kpiDepositWrap', 'kpiWithdrawWrap', 'kpiNetDepositWrap', 'kpiFTDWrap', 'kpiBonusWrap', 'kpiTurnoverWrap', 'kpiCWLWrap', 'kpiNetWLWrap'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            }

            function updateKPIs_DW(rows, monthHeaders) {
                const pick = selectedDwMonth(monthHeaders);
                const monthsUsed = pick ? [pick] : (monthHeaders || []);
                const isDep = r => /deposit/i.test(String(r.Type)) && !/net/i.test(String(r.Type));
                const isWdr = r => /withdraw/i.test(String(r.Type));
                const isNet = r => /net/i.test(String(r.Type));
                let deposit = 0,
                    withdraw = 0,
                    netDep = 0;
                for (const r of rows) {
                    const sum = monthsUsed.reduce((a, m) => a + (+r[m] || 0), 0);
                    if (isDep(r)) deposit += sum;
                    else if (isWdr(r)) withdraw += sum;
                    else if (isNet(r)) netDep += sum;
                }
                if (!netDep) netDep = deposit - withdraw;
                const set = (id, v) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = MONEY(v);
                };
                set('kpiDeposit', deposit);
                set('kpiWithdraw', withdraw);
                set('kpiNetDeposit', netDep);
                ['kpiDepositWrap', 'kpiWithdrawWrap', 'kpiNetDepositWrap'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                ['kpiFTDWrap', 'kpiBonusWrap', 'kpiTurnoverWrap', 'kpiCWLWrap', 'kpiNetWLWrap'].forEach(id => document.getElementById(id).classList.add('hidden'));
            }
            /* ================== PR & DW charting ================== */
            function selectedPrMonth(months) {
                const sel = document.getElementById('prMonth');
                if (!sel || sel.classList.contains('hidden')) return null;
                const val = sel.value || null;
                return val === 'All' ? null : val;
            }

            function selectedDwMonth(months) {
                // Prefer the global state (set by either dropdown). 'All' => null (i.e., no restriction)
                const chosen = (state.dwMonth || 'All').trim();
                if (chosen.toLowerCase() !== 'all') return chosen;
                // Fallback: read from top picker if present/visible
                const sel = document.getElementById('dwMonth');
                if (!sel || sel.classList.contains('hidden')) return null;
                const val = (sel.value || '').trim();
                return val.toLowerCase() === 'all' ? null : val;
            }

            function selectedGroupBy() {
                // Prefer the DW-persisted value when on the DW tab
                if (state.tab === 'dw' && state.dwGroupBy) return state.dwGroupBy;
                // Otherwise read the visible selector (used by PR)
                const sel = document.getElementById('groupBy');
                return sel ? sel.value : 'None';
            }
            let _visiblePRLeaves = []; // for charts
            let _visibleDWRows = [];

            function updateChartsForPR(rows) {
                ensureCharts();
                const t = currentChartTheme();
                let months = [...new Set(rows.map(r => r['Month']).filter(Boolean))]
                    .sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
                const selectedMonth = selectedPrMonth(months);
                if (selectedMonth) {
                    rows = rows.filter(r => r['Month'] === selectedMonth);
                    months = [selectedMonth];
                }
                const gb = selectedGroupBy();
                const m1 = selectedPrMetric('prMetric1') || 'Total Deposit';
                const m2 = selectedPrMetric('prMetric2') || 'Net Deposit';
                const mBar = selectedPrMetric('prMetricBar') || 'Net Deposit';
                const sumOrAvg = (slice, metric) => {
                    if (percentColumns.has(metric)) {
                        const vals = slice.map(r => Number(r[metric]) || 0);
                        return vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length) : 0;
                    }
                    return slice.reduce((a, r) => a + (Number(r[metric]) || 0), 0);
                };
                const computeSeries = (metric, filterFn = () => true) =>
                    months.map(m => sumOrAvg(rows.filter(r => (!m || r['Month'] === m) && filterFn(r)), metric));
                const isSingleMonth = months.length === 1;
                trendChart.type = isSingleMonth ? 'bar' : 'line';
                // ===== Compare tool (visible when grouped) =====
                const compareNode = document.getElementById('trendCompare');
                // Hide compare when grouping by Brand Group
                const showCompare = gb !== 'None' && gb !== 'Brand Group';
                if (compareNode) compareNode.classList.toggle('hidden', !showCompare);
                const allGroups = (gb === 'None') ? [] : distinct(rows, gb);
                if (compareNode && showCompare) {
                    const label = gb === 'Currency' ? 'Compare Currencies' : 'Compare Brands';
                    const iconName = gb === 'Currency' ? 'coins' : 'layers-3';
                    renderMulti('trendCompare', label, iconName, allGroups, state.trendCompare || null);
                }
                const chosenGroups =
                    state.trendCompare === null ?
                    allGroups :
                    (state.trendCompare instanceof Set ?
                        allGroups.filter(g => state.trendCompare.has(g)) :
                        allGroups);
                // ===== Trend chart =====
                if (isSingleMonth) {
                    if (gb !== 'None') {
                        const groups = chosenGroups;
                        trendChart.data.labels = groups;
                        trendChart.data.datasets = [{
                            label: m1,
                            data: groups.map(g => sumOrAvg(rows.filter(r => r[gb] === g), m1)),
                            backgroundColor: groups.map((g, i) => colorPalette[i % colorPalette.length]),
                            borderColor: groups.map((g, i) => colorPalette[i % colorPalette.length]),
                            borderWidth: 1
                        }];
                        const showSecond = !document.getElementById('wrapPrMetric2')?.classList.contains('hidden');
                        if (showSecond) {
                            trendChart.data.datasets.push({
                                label: m2,
                                data: groups.map(g => sumOrAvg(rows.filter(r => r[gb] === g), m2)),
                                backgroundColor: groups.map((g, i) => toRGBA(colorPalette[i % colorPalette.length], .5)),
                                borderColor: groups.map((g, i) => colorPalette[i % colorPalette.length]),
                                borderWidth: 1
                            });
                        }
                    } else {
                        trendChart.data.labels = [m1, m2];
                        trendChart.data.datasets = [{
                            label: months[0],
                            data: [sumOrAvg(rows, m1), sumOrAvg(rows, m2)],
                            backgroundColor: [t.s1, t.s2],
                            borderColor: [t.s1, t.s2],
                            borderWidth: 1
                        }];
                    }
                } else {
                    if (gb === 'None') {
                        trendChart.data.labels = months;
                        trendChart.data.datasets = [{
                                label: m1,
                                data: computeSeries(m1),
                                borderWidth: 2,
                                tension: .18,
                                borderColor: t.s1,
                                backgroundColor: toRGBA(t.s1, .15),
                                pointRadius: 3,
                                pointHoverRadius: 8
                            },
                            {
                                label: m2,
                                data: computeSeries(m2),
                                borderWidth: 2,
                                tension: .15,
                                borderColor: t.s2,
                                backgroundColor: toRGBA(t.s2, .15),
                                pointRadius: 3,
                                pointHoverRadius: 8
                            }
                        ];
                    } else {
                        const groups = chosenGroups;
                        trendChart.data.labels = months;
                        trendChart.data.datasets = groups.map((g, i) => ({
                            label: g,
                            data: computeSeries(m1, r => r[gb] === g),
                            borderWidth: 2,
                            tension: .18,
                            borderColor: colorPalette[i % colorPalette.length],
                            backgroundColor: toRGBA(colorPalette[i % colorPalette.length], .15),
                            pointRadius: 3,
                            pointHoverRadius: 8
                        }));
                    }
                }
                document.getElementById('trendTitle').textContent = gb === 'None' ? 'Monthly Trend' : `${gb} Trend`;
                document.getElementById('leaderTitle').textContent = `Top ${gb==='None'?'Brand Groups':gb+'s'} by ${mBar}`;
                reapplyChartTheme();
                trendChart.update();
                // ===== Leader chart =====
                const byGroup = [...rows.reduce((m, r) => {
                        const k = r[gb] || r['Brand Group'];
                        const v = Number(r[mBar]) || 0;
                        if (!m.has(k)) m.set(k, {
                            sum: 0,
                            cnt: 0
                        });
                        const acc = m.get(k);
                        if (percentColumns.has(mBar)) {
                            acc.sum += v;
                            acc.cnt += 1;
                        } else {
                            acc.sum += v;
                        }
                        return m;
                    }, new Map())]
                    .map(([group, obj]) => ({
                        group,
                        val: percentColumns.has(mBar) ? (obj.cnt ? obj.sum / obj.cnt : 0) : obj.sum
                    }))
                    .sort((a, b) => b.val - a.val).slice(0, 10);
                leaderChart.data.labels = byGroup.map(x => x.group);
                leaderChart.data.datasets = [{
                    label: mBar,
                    data: byGroup.map(x => x.val),
                    borderWidth: 1,
                    borderColor: t.s3,
                    backgroundColor: toRGBA(t.s3, .65),
                    barThickness: 10,
                    maxBarThickness: 12
                }];
                reapplyChartTheme();
                trendChart.update();
                leaderChart.update();
                updateKPIs_PR(rows);
            }

            function updateChartsForDW(rows, monthHeaders) {
                ensureCharts();
                const t = currentChartTheme();
                // Month handling
                let months = (monthHeaders || []).slice()
                    .sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
                const pick = selectedDwMonth(months);
                const selectedMonth = pick || null;
                if (selectedMonth) months = [selectedMonth];
                // Row type predicates
                const isWithdraw = r => String(r['Type'] || '').toLowerCase().includes('withdraw');
                const isNet = r => String(r['Type'] || '').toLowerCase().includes('net');
                const isDeposit = r => String(r['Type'] || '').toLowerCase().includes('deposit') && !isNet(r);
                // Metric selections
                const m1 = (document.getElementById('dwMetric1')?.value) || 'Total Deposit';
                const m2 = (document.getElementById('dwMetric2')?.value) || 'Total Withdraw';
                const typeFn1 = m1 === 'Total Deposit' ? isDeposit : (m1 === 'Total Withdraw' ? isWithdraw : isNet);
                const typeFn2 = m2 === 'Total Deposit' ? isDeposit : (m2 === 'Total Withdraw' ? isWithdraw : isNet);
                // Group By (persisted for DW)
                const gb = selectedGroupBy();
                // Titles respect current Group By
                document.getElementById('trendTitle').textContent =
                    gb === 'None' ? 'Monthly Trend' : `${gb} Trend`;
                document.getElementById('leaderTitle').textContent =
                    gb === 'None' ?
                    'Top Brand Groups by Deposit & Withdraw' :
                    `Top ${gb}s by Deposit & Withdraw`;
                // Helpers
                const computeSeries = (typeFn, filterFn = () => true) =>
                    months.map(m => rows.reduce((a, r) => a + (typeFn(r) && filterFn(r) ? (+r[m] || 0) : 0), 0));
                const isSingleMonth = months.length === 1;
                trendChart.type = isSingleMonth ? 'bar' : 'line';
                // ===== Compare tool (visible when grouping)
                const compareNode = document.getElementById('trendCompare');
                if (compareNode) compareNode.classList.toggle('hidden', gb === 'None');
                // IMPORTANT: do not silently fall back to Brand Group; keep explicit "(Unassigned)"
                const keyOf = (r) => (r[gb] ?? '(Unassigned)');
                if (compareNode && gb !== 'None') {
                    const allGroupsRaw = [...new Set(rows.map(keyOf))];
                    const label = gb === 'Currency' ? 'Compare Currencies' :
                        gb === 'Brand' ? 'Compare Brands' :
                        'Compare Brand Groups';
                    const iconName = gb === 'Currency' ? 'coins' : 'layers-3';
                    renderMulti('trendCompare', label, iconName, allGroupsRaw, state.trendCompare || null);
                }
                // ===== Trend chart
                if (isSingleMonth) {
                    if (gb !== 'None') {
                        const allGroups = [...new Set(rows.map(keyOf))];
                        const groups =
                            state.trendCompare === null ?
                            allGroups :
                            (state.trendCompare instanceof Set ?
                                allGroups.filter(g => state.trendCompare.has(g)) :
                                allGroups);
                        trendChart.data.labels = groups;
                        trendChart.data.datasets = [{
                            label: m1,
                            data: groups.map(g =>
                                rows.reduce((a, r) => a + (typeFn1(r) && keyOf(r) === g ? (+r[months[0]] || 0) : 0), 0)),
                            backgroundColor: groups.map((_, i) => colorPalette[i % colorPalette.length]),
                            borderColor: groups.map((_, i) => colorPalette[i % colorPalette.length]),
                            borderWidth: 1
                        }];
                        const showSecond = !document.getElementById('wrapDwMetric2')?.classList.contains('hidden');
                        if (showSecond) {
                            trendChart.data.datasets.push({
                                label: m2,
                                data: groups.map(g =>
                                    rows.reduce((a, r) => a + (typeFn2(r) && keyOf(r) === g ? (+r[months[0]] || 0) : 0), 0)),
                                backgroundColor: groups.map((_, i) => toRGBA(colorPalette[i % colorPalette.length], .5)),
                                borderColor: groups.map((_, i) => colorPalette[i % colorPalette.length]),
                                borderWidth: 1
                            });
                        }
                    } else {
                        trendChart.data.labels = [m1, m2];
                        trendChart.data.datasets = [{
                            label: months[0],
                            data: [
                                rows.reduce((a, r) => a + (typeFn1(r) ? (+r[months[0]] || 0) : 0), 0),
                                rows.reduce((a, r) => a + (typeFn2(r) ? (+r[months[0]] || 0) : 0), 0)
                            ],
                            backgroundColor: [t.s1, t.s2],
                            borderColor: [t.s1, t.s2],
                            borderWidth: 1
                        }];
                    }
                } else {
                    if (gb === 'None') {
                        trendChart.data.labels = months;
                        trendChart.data.datasets = [{
                                label: m1,
                                data: computeSeries(typeFn1),
                                borderWidth: 2,
                                tension: .15,
                                borderColor: t.s1,
                                backgroundColor: toRGBA(t.s1, .15),
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointHitRadius: 10
                            },
                            {
                                label: m2,
                                data: computeSeries(typeFn2),
                                borderWidth: 2,
                                tension: .15,
                                borderColor: t.s2,
                                backgroundColor: toRGBA(t.s2, .15),
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointHitRadius: 10
                            }
                        ];
                    } else {
                        // Build ranked groups using selection (compare tool)
                        const allGroupsRaw = [...new Set(rows.map(keyOf))];
                        const chosenGroups =
                            state.trendCompare === null ?
                            allGroupsRaw :
                            (state.trendCompare instanceof Set ?
                                allGroupsRaw.filter(g => state.trendCompare.has(g)) :
                                allGroupsRaw);
                        const ranked = chosenGroups.map(g => {
                            const sum = months.reduce((acc, m) =>
                                acc + rows.reduce((a, r) =>
                                    a + (typeFn1(r) && keyOf(r) === g ? (+r[m] || 0) : 0), 0), 0);
                            return {
                                g,
                                sum: isFinite(sum) ? sum : 0
                            };
                        }).sort((a, b) => b.sum - a.sum).slice(0, 12);
                        const groups = ranked.map(x => x.g);
                        trendChart.data.labels = months;
                        trendChart.data.datasets = groups.map((g, i) => ({
                            label: g,
                            data: months.map(m =>
                                rows.reduce((a, r) =>
                                    a + (typeFn1(r) && keyOf(r) === g ? (+r[m] || 0) : 0), 0)),
                            borderWidth: 2,
                            tension: .15,
                            borderColor: colorPalette[i % colorPalette.length],
                            backgroundColor: toRGBA(colorPalette[i % colorPalette.length], .15),
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointHitRadius: 10
                        }));
                    }
                }
                reapplyChartTheme();
                trendChart.update();
                // ===== Leader: Deposits vs Withdraw per group
                const depMap = new Map(),
                    wdrMap = new Map();
                for (const r of rows) {
                    const key = keyOf(r);
                    let amt = 0;
                    months.forEach(m => amt += Number(r[m]) || 0);
                    if (isWithdraw(r)) wdrMap.set(key, (wdrMap.get(key) || 0) + amt);
                    else if (isDeposit(r)) depMap.set(key, (depMap.get(key) || 0) + amt);
                }
                const groupsForBar = [...new Set([...depMap.keys(), ...wdrMap.keys()])];
                groupsForBar.sort((a, b) => (depMap.get(b) || 0) - (depMap.get(a) || 0));
                leaderChart.data.labels = groupsForBar;
                leaderChart.data.datasets = [{
                        label: 'Deposit',
                        data: groupsForBar.map(g => depMap.get(g) || 0),
                        borderWidth: 1,
                        borderColor: t.s1,
                        backgroundColor: toRGBA(t.s1, .70)
                    },
                    {
                        label: 'Withdraw',
                        data: groupsForBar.map(g => wdrMap.get(g) || 0),
                        borderWidth: 1,
                        borderColor: t.s2,
                        backgroundColor: toRGBA(t.s2, .70)
                    }
                ];
                reapplyChartTheme();
                trendChart.update();
                leaderChart.update();
                // KPIs should be computed using full monthHeaders (so the picker logic works)
                updateKPIs_DW(rows, monthHeaders);
            }
            /* ================== Grouped TABLE RENDERERS ================== */
            const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            } [m]));
            const pill = c => `<span class="pill">${esc(c)}</span>`;
            const icon = name => `<i data-lucide="${name}"></i>`;

            function toggleChevron(expanded) {
                return expanded ? icon('chevron-down') : icon('chevron-right');
            }

            function applyQuickFilter(rows) {
                const q = (state.quick || '').trim().toLowerCase();
                if (!q) return rows;
                return rows.filter(r => {
                    return ['Brand Group', 'Brand', 'Currency', 'Month'].some(k => String(r[k] || '').toLowerCase().includes(q)) ||
                        Object.keys(r).some(k => currencyColumns.has(k) && String(r[k] || '').includes(q));
                });
            }

            function passes(setOrNull, value) {
                if (setOrNull === null) return true; // "All" allowed (no filter)
                if (setOrNull.size === 0) return false; // "None" allowed => block all
                return setOrNull.has(String(value));
            }

            function applyMultiFilters(rows) {
                return rows.filter(r =>
                    passes(state.filters.bg, r['Brand Group']) &&
                    passes(state.filters.brand, r['Brand']) &&
                    passes(state.filters.curr, r['Currency'])
                );
            }
            /* ---- Sort & header filters helpers ---- */
            const isNumericCol = (h) => percentColumns.has(h) || currencyColumns.has(h) || countColumns.has(h);
            const sortDirMult = (dir) => dir === 'asc' ? 1 : -1;
            const valForSort = (obj, key) => {
                const v = obj?.[key];
                if (v == null || v === '') return null;
                return isNumericCol(key) ? Number(v) : String(v);
            };

            function cmpValues(a, b, dir) {
                const m = sortDirMult(dir);
                if (a == null && b == null) return 0;
                if (a == null) return 1;
                if (b == null) return -1;
                if (typeof a === 'number' && typeof b === 'number') return (a - b) * m;
                return String(a).localeCompare(String(b)) * m;
            }
            /* Expression matcher (kept for future numeric columns if needed) */
            function matchesExpr(val, exprRaw) {
                if (exprRaw == null || String(exprRaw).trim() === '') return true;
                const expr = String(exprRaw).trim();
                const m = expr.match(/^(>=|<=|>|<|=)\s*(-?\d+(\.\d+)?)/);
                if (m) {
                    const [, op, num] = m;
                    const v = Number(val);
                    const n = Number(num);
                    if (isNaN(v)) return false;
                    if (op === '>') return v > n;
                    if (op === '>=') return v >= n;
                    if (op === '<') return v < n;
                    if (op === '<=') return v <= n;
                    if (op === '=') return v === n;
                }
                return String(val ?? '').toLowerCase().includes(expr.toLowerCase());
            }
            /* Apply header filters: categorical uses Set, (optional) numeric uses expr */
            function applyHeaderFilters(rows) {
                const entries = Object.entries(state.headerFilters || {});
                if (!entries.length) return rows;
                return rows.filter(r => entries.every(([col, f]) => {
                    if (!f) return true;
                    if (f.type === 'set') {
                        // If the set is empty, treat it as "no filter" (or show nothing if you prefer strict).
                        if (!f.values || f.values.size === 0) return true;
                        const v = String(r[col] || '');
                        return f.values.has(v);
                    }
                    if (f.type === 'expr') {
                        return matchesExpr(r[col], f.expr);
                    }
                    return true;
                }));
            }
            /* ---- PR roll-up ---- */
            function rollupPR(baseRows) {
                const keyOf = r => [r['Brand Group'], r['Brand'], r['Currency']].join('||');
                const map = new Map();
                for (const row of baseRows) {
                    const k = keyOf(row);
                    if (!map.has(k)) map.set(k, {
                        ...row
                    });
                    else {
                        const acc = map.get(k);
                        for (const h of Object.keys(row)) {
                            if (currencyColumns.has(h) || countColumns.has(h)) acc[h] = (N(acc[h]) + N(row[h]));
                        }
                    }
                }
                const out = [...map.values()].map(fillDerived);
                return out;
            }

            function aggTotals(rows) {
                const acc = {};
                for (const r of rows) {
                    for (const k of Object.keys(r)) {
                        if (currencyColumns.has(k) || countColumns.has(k)) acc[k] = (N(acc[k]) + N(r[k]));
                    }
                }
                ['Brand Group', 'Brand', 'Currency', 'Month'].forEach(k => {
                    if (acc[k] == null) acc[k] = '';
                });
                return fillDerived(acc);
            }

            function captureScroll() {
                const el = document.querySelector('.tgrid-wrap');
                return el ? {
                    x: el.scrollLeft,
                    y: el.scrollTop
                } : null;
            }

            function restoreScroll(pos) {
                const el = document.querySelector('.tgrid-wrap');
                if (el && pos) el.scrollTo(pos.x, pos.y);
            }
            /* ---- header cell factory ---- */
            function headerTh(label, extraClass = '') {
                const isSorted = state.sort.key === label;
                const dir = isSorted ? state.sort.dir : 'desc';
                const iconName = isSorted ? (dir === 'asc' ? 'arrow-up' : 'arrow-down') : 'arrow-up-down';
                const tip = esc(headerTooltips[label] || '');
                return `
    <th class="${extraClass}${isSorted ? ' sorted' : ''}" data-col="${esc(label)}" title="${tip}">
      <div class="hdr">
        <span class="txt">${esc(label)}</span>
        <span class="hdr-btn sort" data-sort="${esc(label)}" title="Sort">
          <i data-lucide="${iconName}"></i>
        </span>
      </div>
    </th>`;
            }
            /* ---- Utility: sync sticky offsets (in case widths change) ---- */
            function syncStickyOffsets(tableEl) {
                const first = tableEl.querySelector('thead th.col-first');
                if (!first) return;
                const w1 = Math.ceil(first.getBoundingClientRect().width);
                tableEl.style.setProperty('--col-first-width', w1 + 'px');
            }
            const STICKY_BASE = 'var(--panel)';
            /* ---- PR table (revised) ---- */
            function renderTablePR(headers, baseRows) {
                const grid = document.getElementById('grid');
                const wrap = document.createElement('div');
                wrap.className = 'tgrid-wrap';
                const table = document.createElement('table');
                table.className = 'tgrid';
                wrap.appendChild(table);
                const months = distinct(baseRows, 'Month');
                // choices (no header popovers) -> then apply multi-select + quick
                let rowsForChoices = applyQuickFilter(applyMultiFilters(baseRows));
                let rows = rowsForChoices;
                // PR month selector (in-table)
                const chosen = (state.prTableMonth && months.includes(state.prTableMonth)) ? state.prTableMonth : 'All';
                if (chosen !== 'All') rows = rows.filter(r => r.Month === chosen);
                const leaves = rollupPR(rows);
                _visiblePRLeaves = rows;
                const dims = new Set(['Brand Group', 'Brand', 'Currency', 'Month']);
                const cols = headers.filter(h => !dims.has(h));
                table.innerHTML = `
    <thead>
      <tr>
        ${headerTh('Brand Group','col-first sticky-first')}
        ${headerTh('Currency','col-second sticky-second')}
        ${cols.map(h => headerTh(h)).join('')}
      </tr>
      <tr class="row-alt">
        <td colspan="${cols.length + 3}" style="text-align:left">
          <div class="flex items-center gap-2 flex-wrap">
            <strong>Month:</strong>
            <select id="gridPrMonth" class="select-template ml-2">
              <option>All</option>
              ${(months || []).map(m => `<option ${m===chosen?'selected':''}>${esc(m)}</option>`).join('')}
            </select>
            <div id="gridFilterBG" class="multi"></div>
            <div id="gridFilterCurr" class="multi"></div>
            <!-- Expand / Collapse -->
            <button class="btn-template" data-act="expand-all" title="Expand all groups">
              <i data-lucide="chevrons-down"></i><span>Expand</span>
            </button>
            <button class="btn-template" data-act="collapse-all" title="Collapse all groups">
              <i data-lucide="chevrons-up"></i><span>Collapse</span>
            </button>
          </div>
        </td>
      </tr>
    </thead>
    <tbody></tbody>
  `;
                const TB = table.querySelector('tbody');
                // Sorting
                const sortKey = state.sort.key,
                    sortDir = state.sort.dir;
                // Brand Groups default: Total Deposit DESC
                let groupNames = [...new Set(leaves.map(r => r['Brand Group']))];
                if (sortKey) {
                    groupNames.sort((ga, gb) => {
                        if (sortKey === 'Brand Group') return cmpValues(ga, gb, sortDir);
                        const va = valForSort(aggTotals(leaves.filter(r => r['Brand Group'] === ga)), sortKey);
                        const vb = valForSort(aggTotals(leaves.filter(r => r['Brand Group'] === gb)), sortKey);
                        return cmpValues(va, vb, sortDir);
                    });
                } else {
                    const dep = 'Total Deposit';
                    groupNames.sort((ga, gb) => {
                        const va = N(aggTotals(leaves.filter(r => r['Brand Group'] === ga))[dep]);
                        const vb = N(aggTotals(leaves.filter(r => r['Brand Group'] === gb))[dep]);
                        return (vb - va) || String(ga || '').localeCompare(String(gb || ''));
                    });
                }
                for (const bg of groupNames) {
                    const arr = leaves.filter(r => r['Brand Group'] === bg);
                    if (!arr.length) continue;
                    const bgCollapsed = state.collapsedBG.has(bg);
                    const tint = colorForBrandGroup(bg);
                    const bandTint = hexToRGBA(tint, .12);
                    const bandMask = forceOpaqueColor(bandTint, 0.98);
                    const band = document.createElement('tr');
                    band.className = 'group-band';
                    band.innerHTML = `
      <td class="sticky-first col-first" style="background-color:${bandMask}">
        <span class="toggle" data-type="bg" data-bg="${esc(bg)}">
          ${toggleChevron(!bgCollapsed)} <i data-lucide="layers-3"></i> <strong>Brand Group: ${esc(bg)}</strong>
        </span>
      </td>
      <td class="sticky-second col-second" style="background-color:${bandMask}"></td>
      ${cols.map(() => `<td style="background-color:${bandTint}"></td>`).join('')}
    `;
                    band.dataset.bg = bg;
                    band.dataset.basebg = bandTint;
                    band.dataset.maskbg = bandMask;
                    TB.appendChild(band);
                    if (bgCollapsed) continue;
                    // Currencies in this BG — default sort by Total Deposit DESC
                    let currencies = [...new Set(arr.map(r => r['Currency']))];
                    if (sortKey) {
                        currencies.sort((a, b) => {
                            if (sortKey === 'Currency') return cmpValues(a, b, sortDir);
                            const va = valForSort(aggTotals(arr.filter(r => r['Currency'] === a)), sortKey);
                            const vb = valForSort(aggTotals(arr.filter(r => r['Currency'] === b)), sortKey);
                            return cmpValues(va, vb, sortDir);
                        });
                    } else {
                        const dep = 'Total Deposit';
                        currencies.sort((a, b) => {
                            const va = N(aggTotals(arr.filter(r => r['Currency'] === a))[dep]);
                            const vb = N(aggTotals(arr.filter(r => r['Currency'] === b))[dep]);
                            return (vb - va) || String(a || '').localeCompare(String(b || ''));
                        });
                    }
                    for (const cur of currencies) {
                        const curSlice = arr.filter(r => r['Currency'] === cur);
                        const curKey = `${bg}||${cur}`;
                        let curCollapsed = state.collapsedCurrency.has(curKey);
                        if (state.seededCurrency !== true && !state.collapsedCurrency.has(curKey)) {
                            state.collapsedCurrency.add(curKey);
                            curCollapsed = true;
                        }
                        const curTotals = aggTotals(curSlice);
                        const trC = document.createElement('tr');
                        trC.className = 'brand-row';
                        trC.innerHTML = `
        <td class="sticky-first col-first" style="background-color:${STICKY_BASE}">&nbsp;&nbsp;
          <span class="toggle" data-type="currency" data-cur="${esc(curKey)}">
            ${toggleChevron(!curCollapsed)} ${esc(bg)}
          </span>
        </td>
        <td class="sticky-second col-second" style="background-color:${STICKY_BASE}">
          <i data-lucide="coins"></i> <span class="pill">${esc(cur)}</span>
        </td>
        ${cols.map(h => {
          const v = curTotals[h];
          const isNum = (currencyColumns.has(h) || percentColumns.has(h) || countColumns.has(h) || isMonthHeader(h));
          const cls = (Number(v) < 0 && (currencyColumns.has(h) || percentColumns.has(h))) ? 'num num-neg' : (isNum ? 'num' : '');
          return `<td class="${cls}">${classifyFormat(h, v)}</td>`;
        }).join('')}
      `;
                        trC.dataset.bg = bg;
                        trC.dataset.cur = cur;
                        trC.dataset.basebg = '';
                        trC.dataset.maskbg = STICKY_BASE;
                        TB.appendChild(trC);
                        if (curCollapsed) continue;
                        // Brands under this currency — Total Deposit DESC
                        let brands = [...new Set(curSlice.map(r => r['Brand']))];
                        const depKey = 'Total Deposit';
                        brands.sort((a, b) => {
                            const va = N(aggTotals(curSlice.filter(r => r['Brand'] === a))[depKey]);
                            const vb = N(aggTotals(curSlice.filter(r => r['Brand'] === b))[depKey]);
                            return (vb - va) || String(a || '').localeCompare(String(b || ''));
                        });
                        brands.forEach((brand, i) => {
                            const rowData = curSlice.find(r => r['Brand'] === brand);
                            const row = document.createElement('tr');
                            if (i % 2 === 1) row.classList.add('row-alt');
                            row.innerHTML = `
          <td class="sticky-first col-first" style="background-color:${STICKY_BASE}">&nbsp;&nbsp;&nbsp;&nbsp;${esc(brand)}</td>
          <td class="sticky-second col-second" style="background-color:${STICKY_BASE}"><span class="pill">${esc(cur)}</span></td>
          ${cols.map(h => {
            const v = rowData[h];
            const isNum = (currencyColumns.has(h) || percentColumns.has(h) || countColumns.has(h) || isMonthHeader(h));
            const cls = (Number(v) < 0 && (currencyColumns.has(h) || percentColumns.has(h))) ? 'num num-neg' : (isNum ? 'num' : '');
            return `<td class="${cls}">${classifyFormat(h, v)}</td>`;
          }).join('')}
        `;
                            row.dataset.bg = bg;
                            row.dataset.cur = cur;
                            row.dataset.brand = brand;
                            row.dataset.basebg = '';
                            row.dataset.maskbg = STICKY_BASE;
                            TB.appendChild(row);
                        });
                    }
                }
                state.seededCurrency = true;
                // Mount
                grid.innerHTML = '';
                grid.appendChild(wrap);
                refreshIcons();
                syncStickyOffsets(table);
                // Inline multi-selects (under header)
                renderMulti('gridFilterBG', 'Brand Groups', 'layers-3', domainFor('Brand Group', baseRows), state.filters.bg);
                renderMulti('gridFilterCurr', 'Currency', 'coins', domainFor('Currency', baseRows), state.filters.curr);
                // Sorting & expand/collapse
                table.addEventListener('click', (e) => {
                    const actBtn = e.target.closest('[data-act]');
                    const sortBtn = e.target.closest('[data-sort]');
                    if (actBtn) {
                        const act = actBtn.getAttribute('data-act');
                        if (act === 'expand-all') {
                            state.collapsedBG.clear();
                            state.collapsedCurrency.clear();
                            rebuildTableForCurrent();
                            return;
                        }
                        if (act === 'collapse-all') {
                            const allBGs = [...new Set(leaves.map(r => r['Brand Group']))];
                            state.collapsedBG = new Set(allBGs);
                            const allCurKeys = [];
                            for (const bg of allBGs) {
                                const curs = [...new Set(leaves.filter(r => r['Brand Group'] === bg).map(r => r['Currency']))];
                                curs.forEach(c => allCurKeys.push(`${bg}||${c}`));
                            }
                            state.collapsedCurrency = new Set(allCurKeys);
                            rebuildTableForCurrent();
                            return;
                        }
                    }
                    if (sortBtn) {
                        const col = sortBtn.getAttribute('data-sort');
                        if (state.sort.key === col) state.sort.dir = (state.sort.dir === 'asc') ? 'desc' : 'asc';
                        else {
                            state.sort.key = col;
                            state.sort.dir = 'desc';
                        }
                        rebuildTableForCurrent();
                    }
                });
                table.querySelector('#gridPrMonth')?.addEventListener('change', e => {
                    state.prTableMonth = e.target.value || 'All';
                    const topSel = document.getElementById('prMonth');
                    if (topSel) topSel.value = e.target.value;
                    rebuildTableForCurrent();
                });
                wireRowHighlight(wrap);
                wireExpandCollapse(wrap);
                updateChartsForPR(rows);
            }

            function renderTableDW(allHeaders, rows, monthHeaders) {
                const grid = document.getElementById('grid');
                // container/table
                const wrap = document.createElement('div');
                wrap.className = 'tgrid-wrap';
                const table = document.createElement('table');
                table.className = 'tgrid';
                wrap.appendChild(table);
                // months & selection
                let months = (monthHeaders || []).slice()
                    .sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
                const persisted = (state.dwMonth && state.dwMonth !== 'All') ? state.dwMonth : null;
                const gridPick = (document.getElementById('gridDwMonth')?.value) || 'All';
                const pick = persisted || ((gridPick && gridPick !== 'All') ? gridPick : selectedDwMonth(months));
                const useMonths = pick ? [pick] : months;
                // filters
                let filteredChoices = applyQuickFilter(applyMultiFilters(rows));
                let filtered = filteredChoices;
                _visibleDWRows = filtered;
                // stacked cell builder
                const stackCell = (dep, wdr, net) => {
                    const neg = Number(net) < 0 ? 'neg' : '';
                    return `
      <div class="stack3">
        <div class="ln dep"><i data-lucide="banknote"></i><span>${MONEY(dep)}</span></div>
        <div class="ln wdr"><i data-lucide="wallet"></i><span>${MONEY(wdr)}</span></div>
        <div class="ln net ${neg}"><i data-lucide="move-diagonal-2"></i><span>${MONEY(net)}</span></div>
      </div>`;
                };
                // header
                table.innerHTML = `
    <thead>
      <tr>
        ${headerTh('Brand Group','col-first sticky-first')}
        ${headerTh('Currency','col-second sticky-second')}
        ${headerTh('Cash Flow')}
        ${useMonths.map(m => headerTh(m)).join('')}
      </tr>
      <tr class="row-alt">
        <td colspan="${useMonths.length + 3}" style="text-align:left">
          <div class="flex items-center gap-2 flex-wrap">
            <strong>Month:</strong>
            <select id="gridDwMonth" class="select-template ml-2">
              <option>All</option>
              ${(months || []).map(m => `<option ${m===pick?'selected':''}>${esc(m)}</option>`).join('')}
            </select>
            <div id="gridFilterBG" class="multi"></div>
            <div id="gridFilterCurr" class="multi"></div>
            <!-- Expand / Collapse -->
            <button class="btn-template" data-act="expand-all" title="Expand all groups">
              <i data-lucide="chevrons-down"></i><span>Expand</span>
            </button>
            <button class="btn-template" data-act="collapse-all" title="Collapse all groups">
              <i data-lucide="chevrons-up"></i><span>Collapse</span>
            </button>
          </div>
        </td>
      </tr>
    </thead>
    <tbody></tbody>
  `;
                const TB = table.querySelector('tbody');
                // helpers
                const isWithdraw = r => String(r['Type'] || '').toLowerCase().includes('withdraw');
                const isNet = r => String(r['Type'] || '').toLowerCase().includes('net');
                const isDeposit = r => String(r['Type'] || '').toLowerCase().includes('deposit') && !isNet(r);
                const sumBy = (slice, pred) => useMonths.map(m =>
                    slice.reduce((a, r) => a + (pred(r) ? (+r[m] || 0) : 0), 0)
                );
                // sort brand groups (default deposit desc)
                const depTotalForBG = (bg) => {
                    const byBG = filtered.filter(r => r['Brand Group'] === bg);
                    const totals = sumBy(byBG, isDeposit);
                    return totals.reduce((a, b) => a + b, 0);
                };
                let groupNames = [...new Set(filtered.map(r => r['Brand Group']))];
                if (state.sort.key === 'Brand Group') {
                    groupNames.sort((a, b) => (String(a || '').localeCompare(String(b || ''))) * (state.sort.dir === 'asc' ? 1 : -1));
                } else {
                    groupNames.sort((a, b) => (depTotalForBG(b) - depTotalForBG(a)) || String(a || '').localeCompare(String(b || '')));
                }
                for (const bg of groupNames) {
                    const byBG = filtered.filter(r => r['Brand Group'] === bg);
                    if (!byBG.length) continue;
                    const bgCollapsed = state.collapsedBG.has(bg);
                    // band tint
                    const tint = colorForBrandGroup(bg);
                    const bandTint = hexToRGBA(tint, .12);
                    const bandMask = forceOpaqueColor(bandTint, 0.98);
                    const band = document.createElement('tr');
                    band.className = 'group-band';
                    band.innerHTML = `
      <td class="sticky-first col-first" style="background-color:${bandMask}">
        <span class="toggle" data-type="bg" data-bg="${esc(bg)}">
          ${toggleChevron(!bgCollapsed)} <i data-lucide="layers-3"></i> <strong>Brand Group: ${esc(bg)}</strong>
        </span>
      </td>
      <td class="sticky-second col-second" style="background-color:${bandMask}"></td>
      <td style="background-color:${bandTint}"></td>
      ${useMonths.map(() => `<td style="background-color:${bandTint}"></td>`).join('')}
    `;
                    band.dataset.bg = bg;
                    band.dataset.basebg = bandTint;
                    band.dataset.maskbg = bandMask;
                    TB.appendChild(band);
                    if (bgCollapsed) continue;
                    // currencies under BG — deposit desc
                    let currencies = [...new Set(byBG.map(r => r['Currency']))];
                    const depTotalCur = (cur) => sumBy(byBG.filter(r => r['Currency'] === cur), isDeposit).reduce((a, b) => a + b, 0);
                    currencies.sort((a, b) => (depTotalCur(b) - depTotalCur(a)) || String(a || '').localeCompare(String(b || '')));
                    for (const cur of currencies) {
                        const curSlice = byBG.filter(r => r['Currency'] === cur);
                        const key = `${bg}||${cur}`;
                        let curCollapsed = state.collapsedCurrency.has(key);
                        if (state.seededCurrency !== true && !state.collapsedCurrency.has(key)) {
                            state.collapsedCurrency.add(key);
                            curCollapsed = true;
                        }
                        const depArr = sumBy(curSlice, isDeposit);
                        const wdrArr = sumBy(curSlice, isWithdraw);
                        let netArr = sumBy(curSlice, isNet);
                        if (!curSlice.some(isNet)) netArr = depArr.map((v, i) => v - (wdrArr[i] || 0));
                        const trCur = document.createElement('tr');
                        trCur.className = 'brand-row';
                        trCur.innerHTML = `
        <td class="sticky-first col-first" style="background-color:${STICKY_BASE}">&nbsp;&nbsp;
          <span class="toggle" data-type="currency" data-cur="${esc(key)}">
            ${toggleChevron(!curCollapsed)} ${esc(bg)}
          </span>
        </td>
        <td class="sticky-second col-second" style="background-color:${STICKY_BASE}">
          <i data-lucide="coins"></i> <span class="pill">${esc(cur)}</span>
        </td>
        <td>
          <div class="stack3">
            <div class="ln dep"><i data-lucide="banknote"></i><span>Total Deposit</span></div>
            <div class="ln wdr"><i data-lucide="wallet"></i><span>Total Withdraw</span></div>
            <div class="ln net"><i data-lucide="move-diagonal-2"></i><span>Total Net Deposit</span></div>
          </div>
        </td>
        ${useMonths.map((_, i) => `<td class="num">${stackCell(depArr[i], wdrArr[i], netArr[i])}</td>`).join('')}
      `;
                        trCur.dataset.bg = bg;
                        trCur.dataset.cur = cur;
                        trCur.dataset.basebg = '';
                        trCur.dataset.maskbg = STICKY_BASE;
                        TB.appendChild(trCur);
                        if (curCollapsed) continue;
                        // brand rows under currency — deposit desc
                        let brands = [...new Set(curSlice.map(r => r['Brand']))];
                        const brandDep = (brand) => sumBy(curSlice.filter(r => r['Brand'] === brand), isDeposit).reduce((a, b) => a + b, 0);
                        brands.sort((a, b) => (brandDep(b) - brandDep(a)) || String(a || '').localeCompare(String(b || '')));
                        for (const brand of brands) {
                            const sliceB = curSlice.filter(r => r['Brand'] === brand);
                            const depB = sumBy(sliceB, isDeposit);
                            const wdrB = sumBy(sliceB, isWithdraw);
                            let netB = sumBy(sliceB, isNet);
                            if (!sliceB.some(isNet)) netB = depB.map((v, i) => v - (wdrB[i] || 0));
                            const trB = document.createElement('tr');
                            trB.innerHTML = `
          <td class="sticky-first col-first" style="background-color:${STICKY_BASE}">&nbsp;&nbsp;&nbsp;&nbsp;${esc(brand)}</td>
          <td class="sticky-second col-second" style="background-color:${STICKY_BASE}"><span class="pill">${esc(cur)}</span></td>
          <td>
            <div class="stack3">
              <div class="ln dep"><i data-lucide="banknote"></i><span>Total Deposit</span></div>
              <div class="ln wdr"><i data-lucide="wallet"></i><span>Total Withdraw</span></div>
              <div class="ln net"><i data-lucide="move-diagonal-2"></i><span>Total Net Deposit</span></div>
            </div>
          </td>
          ${useMonths.map((_, i) => `<td class="num">${stackCell(depB[i], wdrB[i], netB[i])}</td>`).join('')}
        `;
                            trB.dataset.bg = bg;
                            trB.dataset.cur = cur;
                            trB.dataset.brand = brand;
                            trB.dataset.basebg = '';
                            trB.dataset.maskbg = STICKY_BASE;
                            TB.appendChild(trB);
                        }
                    }
                }
                // mount & icons
                grid.innerHTML = '';
                grid.appendChild(wrap);
                refreshIcons();
                syncStickyOffsets(table);
                // inline multi-selects
                renderMulti('gridFilterBG', 'Brand Groups', 'layers-3', domainFor('Brand Group', rows), state.filters.bg);
                renderMulti('gridFilterCurr', 'Currency', 'coins', domainFor('Currency', rows), state.filters.curr);
                // month selector
                table.querySelector('#gridDwMonth')?.addEventListener('change', (e) => {
                    const val = (e.target.value || 'All');
                    state.dwMonth = val;
                    const topSel = document.getElementById('dwMonth');
                    if (topSel) topSel.value = val;
                    rebuildTableForCurrent();
                });
                // header sorting + expand/collapse
                table.addEventListener('click', (e) => {
                    const actBtn = e.target.closest('[data-act]');
                    const sortBtn = e.target.closest('[data-sort]');
                    if (actBtn) {
                        const act = actBtn.getAttribute('data-act');
                        if (act === 'expand-all') {
                            state.collapsedBG.clear();
                            state.collapsedCurrency.clear();
                            rebuildTableForCurrent();
                            return;
                        }
                        if (act === 'collapse-all') {
                            const allBGs = [...new Set(filtered.map(r => r['Brand Group']))];
                            state.collapsedBG = new Set(allBGs);
                            const allCurKeys = [];
                            for (const bg of allBGs) {
                                const curs = [...new Set(filtered.filter(r => r['Brand Group'] === bg).map(r => r['Currency']))];
                                curs.forEach(c => allCurKeys.push(`${bg}||${c}`));
                            }
                            state.collapsedCurrency = new Set(allCurKeys);
                            rebuildTableForCurrent();
                            return;
                        }
                    }
                    if (sortBtn) {
                        const col = sortBtn.getAttribute('data-sort');
                        if (state.sort.key === col) state.sort.dir = (state.sort.dir === 'asc') ? 'desc' : 'asc';
                        else {
                            state.sort.key = col;
                            state.sort.dir = 'desc';
                        }
                        rebuildTableForCurrent();
                    }
                });
                wireRowHighlight(wrap);
                wireExpandCollapse(wrap);
                updateChartsForDW(filtered, monthHeaders);
            }
            /* Prepare filters based on current rows */
            function prepareFiltersForRows(rows) {
                const bgs = distinct(rows, 'Brand Group');
                const brands = distinct(rows, 'Brand');
                const currs = distinct(rows, 'Currency');
                renderMulti('filterBG', 'Brand Groups', 'layers-3', bgs, state.filters.bg);
                renderMulti('filterBrand', 'Brands', 'building-2', brands, state.filters.brand);
                renderMulti('filterCurr', 'Currency', 'coins', currs, state.filters.curr);
            }

            function domainFor(col, rows) {
                return distinct(rows || [], col);
            }

            function populateHeaderFilterPops(tableEl, rowsForChoices) {
                const cols = ['Brand Group', 'Brand', 'Currency'];
                cols.forEach(col => {
                    const th = tableEl.querySelector(`th[data-col="${col}"]`);
                    if (!th) return;
                    const pop = th.querySelector('.filter-pop');
                    if (!pop) return;
                    const values = distinct(rowsForChoices, col);
                    const selectedSet = (state.headerFilters[col]?.type === 'set') ? state.headerFilters[col].values : null;
                    const allSelected = !selectedSet || selectedSet.size === 0;
                    pop.innerHTML = `
      <div class="multi-scroll" style="max-height:240px;overflow:auto;padding:6px;">
        ${values.map(v => {
          const checked = allSelected || selectedSet?.has(v);
          return `<label class="multi-item"><input type="checkbox" value="${esc(v)}" ${checked ? 'checked' : ''}/> <span>${esc(v)}</span></label>`;
        }).join('')}
      </div>
      <div class="mt-2 flex gap-2 justify-end">
        <button class="btn-template" data-all="${esc(col)}">All</button>
        <button class="btn-template" data-none="${esc(col)}">None</button>
        <button class="btn-template" data-apply="${esc(col)}">Apply</button>
        <button class="btn-template" data-close="${esc(col)}">Close</button>
      </div>`;
                });
            }

            function wireExpandCollapse(wrapEl) {
                if (!wrapEl) return;
                wrapEl.addEventListener('click', (e) => {
                    const t = e.target.closest('.toggle');
                    if (!t) return;
                    const type = t.dataset.type;
                    if (type === 'bg') {
                        const bg = t.dataset.bg;
                        if (state.collapsedBG.has(bg)) state.collapsedBG.delete(bg);
                        else state.collapsedBG.add(bg);
                    } else if (type === 'currency') {
                        const key = t.dataset.cur;
                        if (state.collapsedCurrency.has(key)) state.collapsedCurrency.delete(key);
                        else state.collapsedCurrency.add(key);
                    }
                    rebuildTableForCurrent();
                });
            }

            function wireRowHighlight(wrapEl) {
                if (!wrapEl) return;
                const rows = [...wrapEl.querySelectorAll('tbody tr')];
                // Reset every row to its natural (CSS) background.
                const resetRow = (tr) => {
                    tr.style.backgroundColor = '';
                    tr.querySelectorAll('td').forEach(td => {
                        // sticky cells get a neutral theme base so they properly cover what's behind
                        if (td.classList.contains('sticky-first') || td.classList.contains('sticky-second')) {
                            td.style.backgroundColor = tr.dataset.maskbg || STICKY_BASE;
                        } else {
                            td.style.backgroundColor = '';
                        }
                    });
                };
                const hiMain = cssVar('--hl-row') || 'rgba(59,130,246,.16)';
                const hiStrong = cssVar('--hl-row-strong') || 'rgba(59,130,246,.26)';
                const hiMask = cssVar('--hl-row-mask') || 'rgba(59,130,246,.98)';

                function applyHighlight(matchFn, strongFn = () => false) {
                    rows.forEach(tr => {
                        if (strongFn(tr)) {
                            tr.style.backgroundColor = hiStrong;
                            tr.querySelectorAll('td').forEach(td => {
                                td.style.backgroundColor = (td.classList.contains('sticky-first') || td.classList.contains('sticky-second')) ? hiMask : hiStrong;
                            });
                        } else if (matchFn(tr)) {
                            tr.style.backgroundColor = hiMain;
                            tr.querySelectorAll('td').forEach(td => {
                                td.style.backgroundColor = (td.classList.contains('sticky-first') || td.classList.contains('sticky-second')) ? hiMask : hiMain;
                            });
                        } else {
                            resetRow(tr);
                        }
                    });
                }

                function onHover(target) {
                    const pill = target.closest('.pill'); // currency chip
                    const tr = target.closest('tr');
                    if (!tr && !pill) return;
                    if (pill) {
                        // Highlight same currency but ONLY within the same Brand Group
                        const curr = pill.textContent.trim();
                        const row = pill.closest('tr');
                        const bg = row?.dataset?.bg || '';
                        applyHighlight(t => (t.dataset.cur || '') === curr && (t.dataset.bg || '') === bg);
                        return;
                    }
                    if (tr.classList.contains('group-band')) {
                        const bg = tr.dataset.bg || '';
                        applyHighlight(t => (t.dataset.bg || '') === bg, t => t === tr);
                        return;
                    }
                    if (tr.dataset.cur) {
                        // Scope by both Currency and the current Brand Group
                        const cur = tr.dataset.cur;
                        const bg = tr.dataset.bg || '';
                        applyHighlight(t => (t.dataset.cur || '') === cur && (t.dataset.bg || '') === bg, t => t === tr);
                        return;
                    }
                    if (tr.dataset.brand) {
                        const brand = tr.dataset.brand;
                        applyHighlight(t => (t.dataset.brand || '') === brand, t => t === tr);
                        return;
                    }
                }
                const clearHL = () => rows.forEach(resetRow);
                wrapEl.addEventListener('mouseover', e => onHover(e.target));
                wrapEl.addEventListener('mouseout', clearHL);
            }
            /* ================== Controls (metrics pickers) ================== */
            function preparePrMetricPickers(headers, months) {
                const block = new Set(['Month', 'Brand Group', 'Brand', 'Currency']);
                const metrics = headers.filter(h => !block.has(h));
                const d1 = metrics.includes('Total Deposit') ? 'Total Deposit' : (metrics[0] || '');
                const d2 = metrics.includes('Net Deposit') ? 'Net Deposit' : (metrics[1] || d1);
                fillSelect('prMetric1', metrics, d1);
                fillSelect('prMetric2', metrics, d2);
                fillSelect('prMetricBar', metrics, d2);
                fillSelect('prMonth', ['All', ...months], 'All');
                fillSelect('groupBy', ['None', 'Brand Group', 'Brand', 'Currency'], 'Brand Group');
                setSelectVisible('wrapPrMetric1', true);
                setSelectVisible('wrapPrMetric2', false);
                setSelectVisible('wrapPrMetricBar', true);
                setSelectVisible('wrapPrMonth', false);
                setSelectVisible('wrapGroupBy', true);
                // Hide DW controls on PR tab
                setSelectVisible('wrapDwMonth', false);
                setSelectVisible('wrapDwMetric1', false);
                setSelectVisible('wrapDwMetric2', false);
                // ── NEW: show/hide the trendCompare tool based on Group By === 'None'
                const compareNode = document.getElementById('trendCompare');
                if (compareNode) compareNode.classList.toggle(
                    'hidden',
                    (document.getElementById('groupBy')?.value || 'None') === 'None'
                );
                ['prMetric1', 'prMetric2', 'prMetricBar', 'prMonth', 'groupBy'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.onchange = () => {
                        if (id === 'groupBy') {
                            const gb = el.value;
                            // Only show the second metric when not grouping (two-series compare)
                            setSelectVisible('wrapPrMetric2', gb === 'None');
                            // Keep trendCompare visibility in sync with current grouping
                            const compareNode = document.getElementById('trendCompare');
                            if (compareNode) compareNode.classList.toggle('hidden', gb === 'None');
                        }
                        chartRefreshFromCurrent();
                    };
                });
                refreshIcons();
            }

            function prepareDwControls(months) {
                // DW Month dropdown (top bar)
                const sel = document.getElementById('dwMonth');
                if (sel) {
                    sel.innerHTML = ['All', ...months].map(m => `<option>${m}</option>`).join('');
                    // Preserve previously chosen month across rebuilds
                    sel.value = (state.dwMonth && months.includes(state.dwMonth)) ? state.dwMonth : 'All';
                    sel.onchange = () => {
                        state.dwMonth = sel.value || 'All';
                        // Rebuild table + charts + KPIs to reflect the new month
                        rebuildTableForCurrent();
                    };
                }
                // Metric pickers (DW)
                const metrics = ['Total Deposit', 'Total Withdraw', 'Total Net Deposit'];
                fillSelect('dwMetric1', metrics, 'Total Deposit');
                fillSelect('dwMetric2', metrics, 'Total Withdraw');
                // ---- Group By: preserve user choice across DW rebuilds
                const gbOptions = ['None', 'Brand Group', 'Brand', 'Currency'];
                const prevGB = state.dwGroupBy || document.getElementById('groupBy')?.value || 'Brand Group';
                fillSelect('groupBy', gbOptions, prevGB);
                // Wire changes
                ['dwMetric1', 'dwMetric2', 'groupBy'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.onchange = () => {
                        if (id === 'groupBy') {
                            state.dwGroupBy = el.value; // remember user choice
                            const gb = el.value;
                            // Only show the second metric when not grouping (two-series compare)
                            setSelectVisible('wrapDwMetric2', gb === 'None');
                            // Compare tool visible only when grouping
                            const compareNode = document.getElementById('trendCompare');
                            if (compareNode) compareNode.classList.toggle('hidden', gb === 'None');
                        }
                        chartRefreshFromCurrent();
                    };
                });
                // Show DW controls, hide PR-only ones
                setSelectVisible('wrapDwMonth', true);
                setSelectVisible('wrapDwMetric1', true);
                setSelectVisible('wrapDwMetric2', (state.dwGroupBy || prevGB) === 'None'); // keep visibility in sync
                setSelectVisible('wrapGroupBy', true);
                setSelectVisible('wrapPrMetric1', false);
                setSelectVisible('wrapPrMetric2', false);
                setSelectVisible('wrapPrMetricBar', false);
                setSelectVisible('wrapPrMonth', false);
                // Keep Compare tool visibility in sync with current GB
                const compareNode = document.getElementById('trendCompare');
                if (compareNode) compareNode.classList.toggle('hidden', (state.dwGroupBy || prevGB) === 'None');
                refreshIcons();
            }
            /* ================== Rebuild helpers ================== */
            function chartRefreshFromCurrent() {
                if (state.tab === 'pr') {
                    updateChartsForPR(_visiblePRLeaves);
                } else {
                    const months = state.raw?.dw?.monthHeaders || [];
                    updateChartsForDW(_visibleDWRows, months);
                }
            }

            function rebuildTableForCurrent() {
                const scroll = captureScroll(); // preserve scroll to cut flicker
                const display = document.getElementById('currency')?.value || 'Original';
                const key = currencyModeKey(display);
                if (state.tab === 'pr') {
                    const headers = state.raw.pr.headers;
                    const rows = deepCopy(state.rowsCache.pr[key] || []);
                    const months = distinct(rows, 'Month');
                    preparePrMetricPickers(headers, months);
                    renderTablePR(headers, rows);
                } else {
                    const headers = state.raw.dw.headers;
                    const rows = deepCopy(state.rowsCache.dw[key] || []);
                    prepareDwControls(state.raw.dw.monthHeaders || []);
                    renderTableDW(headers, rows, state.raw.dw.monthHeaders || []);
                }
                restoreScroll(scroll);
            }
            /* ================== Refresh ================== */
            function setRefreshSpinning(on) {
                const btn = document.getElementById('refresh');
                if (!btn) return;
                btn.setAttribute('aria-busy', on ? 'true' : 'false');
            }
            async function refresh(opts = {}) {
                const forceReload = !!opts.forceReload;
                const display = (document.getElementById('currency')?.value) || 'Original';
                setRefreshSpinning(true);
                try {
                    if (!state.raw.pr || !state.raw.dw || forceReload) {
                        await prefetchAll();
                        state.multiUniverse = {}; // reset universes after real reload
                    }
                    await buildCachesForMode(display);
                    rebuildTableForCurrent();
                } catch (e) {
                    console.error(e);
                    alert('Error: ' + e.message);
                } finally {
                    setRefreshSpinning(false);
                    refreshIcons();
                }
            }
            /* ================== Modal, theme & wiring ================== */
            function helperModal(open) {
                const m = document.getElementById('helperModal');
                if (!m) return;
                const isOpen = m.classList.contains('open');
                const lock = on => {
                    document.documentElement.style.overflow = on ? 'hidden' : '';
                    document.body.style.overscrollBehavior = on ? 'contain' : '';
                };
                if (open === true && !isOpen) {
                    m.classList.add('open');
                    m.setAttribute('aria-hidden', 'false');
                    helperModal._prev = document.activeElement;
                    const first = m.querySelector('[data-close]');
                    first && first.focus();
                    lock(true);
                    refreshIcons();
                }
                if (open === false && isOpen) {
                    m.classList.remove('open');
                    m.setAttribute('aria-hidden', 'true');
                    lock(false);
                    helperModal._prev && helperModal._prev.focus();
                }
            }

            function wireHelperModal() {
                const openBtn = document.getElementById('helper');
                openBtn && openBtn.addEventListener('click', () => helperModal(true));
                const modal = document.getElementById('helperModal');
                if (!modal) return;
                modal.addEventListener('click', e => {
                    if (e.target.classList.contains('modal-backdrop')) {
                        e.preventDefault();
                        helperModal(false);
                        return;
                    }
                    if (e.target.closest('[data-close]')) {
                        e.preventDefault();
                        helperModal(false);
                        return;
                    }
                });
                modal.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', e => {
                    e.preventDefault();
                    helperModal(false);
                }));
                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape') helperModal(false);
                });
            }
            // ==== Modal open/close ====
            function rateModal(open) {
                const m = document.getElementById('rateModal');
                if (!m) return;
                const lock = on => {
                    document.documentElement.style.overflow = on ? 'hidden' : '';
                    document.body.style.overscrollBehavior = on ? 'contain' : '';
                };
                const isOpen = m.classList.contains('open');
                if (open === true && !isOpen) {
                    m.classList.add('open');
                    m.setAttribute('aria-hidden', 'false');
                    lock(true);
                    refreshIcons();
                }
                if (open === false && isOpen) {
                    m.classList.remove('open');
                    m.setAttribute('aria-hidden', 'true');
                    lock(false);
                }
            }
            // Months helpers
            function monthsForCurrentTab() {
                if (state.tab === 'dw') return (state.raw?.dw?.monthHeaders || []).slice();
                const rows = state.rowsCache?.pr?.[currencyModeKey()] || state.raw?.pr?.rows || [];
                const ms = [...new Set(rows.map(r => r.Month).filter(Boolean))];
                ms.sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));
                return ms;
            }

            function selectedMonthForRates() {
                if (state.tab === 'dw') return selectedDwMonth(state.raw?.dw?.monthHeaders || []) || null;
                return selectedPrMonth() || null;
            }
            async function ensureMonthlyRatesCached(months) {
                if (!months || !months.length) return;
                if (!state.fxCache.monthly) state.fxCache.monthly = {};
                const need = months.map(monthKey).filter(ym => !state.fxCache.monthly[ym]);
                if (!need.length) return;
                const pack = await server.getMonthlyRates(need);
                Object.keys(pack || {}).forEach(ym => {
                    state.fxCache.monthly[ym] = normalizeAndOrientRates_(extractRates(pack[ym]));
                });
            }
            async function fetchLiveRates() {
                try {
                    const payload = await server.getRates();
                    state.fxCache.live = normalizeAndOrientRates_(extractRates(payload));
                    console.log('[FX] Live rates fetched:', {
                        date: payload?.date,
                        keys: Object.keys(state.fxCache.live).length
                    });
                } catch (e) {
                    console.warn('[FX] Failed to fetch live rates:', e);
                    state.fxCache.live = state.fxCache.live || {};
                }
            }
            const RATE_COUNTRY = {
                USD: "US",
                AED: "AE",
                AUD: "AU",
                BDT: "BD",
                BRL: "BR",
                CAD: "CA",
                CNY: "CN",
                EUR: "EU",
                HKD: "HK",
                IDR: "ID",
                INR: "IN",
                KRW: "KR",
                LKR: "LK",
                MMK: "MM",
                MYR: "MY",
                NPR: "NP",
                OMR: "OM",
                PHP: "PH",
                PKR: "PK",
                SAR: "SA",
                SGD: "SG",
                THB: "TH",
                TRY: "TR",
                VND: "VN"
            };
            const RATE_LABEL = {
                USD: "US Dollar",
                AED: "UAE Dirham",
                AUD: "Australian Dollar",
                BDT: "Bangladeshi Taka",
                BRL: "Brazilian Real",
                CAD: "Canadian Dollar",
                CNY: "Chinese Yuan",
                EUR: "Euro",
                HKD: "Hong Kong Dollar",
                IDR: "Indonesian Rupiah",
                INR: "Indian Rupee",
                KRW: "South Korean Won",
                LKR: "Sri Lankan Rupee",
                MMK: "Myanmar Kyat",
                MYR: "Malaysian Ringgit",
                NPR: "Nepalese Rupee",
                OMR: "Omani Rial",
                PHP: "Philippine Peso",
                PKR: "Pakistani Rupee",
                SAR: "Saudi Riyal",
                SGD: "Singapore Dollar",
                THB: "Thai Baht",
                TRY: "Turkish Lira",
                VND: "Vietnamese Dong"
            };
            const RATE_ORDERED_CCYS = [
                "BDT", "INR", "PKR", "VND", "PHP", "OMR", "NPR", "SAR", "CNY", "AUD", "SGD", "MYR",
                "BRL", "HKD", "IDR", "TRY", "USD", "KRW", "THB", "CAD", "MMK", "AED", "LKR"
            ];

            function flagSVG(cc) {
                const round = (inner) => `<svg viewBox="0 0 60 40" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="r"><rect width="60" height="40" rx="8" ry="8"/></clipPath></defs><g clip-path="url(#r)">${inner}</g></svg>`;
                const bands = (a, b, c) => round(`<rect width="60" height="40" fill="${a}"/><rect y="13.33" width="60" height="13.34" fill="${b}"/><rect y="26.67" width="60" height="13.33" fill="${c}"/>`);
                const two = (a, b) => round(`<rect width="60" height="40" fill="${a}"/><rect y="20" width="60" height="20" fill="${b}"/>`);
                const triV = (a, b, c) => round(`<rect width="60" height="40" fill="${a}"/><rect x="20" width="20" height="40" fill="${b}"/><rect x="40" width="20" height="40" fill="${c}"/>`);
                switch (cc) {
                    case "US":
                        return round(`<rect width="60" height="40" fill="#b22234"/>${Array.from({length:6}).map((_,i)=>` < rect y = "${(i*2+1)*40/13}"
                            width = "60"
                            height = "${40/13}"
                            fill = "#fff" / > `).join("")}<rect width="27" height="21" fill="#3c3b6e"/>`);
                    case "CA":
                        return triV("#ff0000", "#fff", "#ff0000");
                    case "BR":
                        return round(`<rect width="60" height="40" fill="#009c3b"/><rect x="10" y="12" width="40" height="16" transform="rotate(45 30 20)" fill="#ffdf00" opacity=".9"/>`);
                    case "TR":
                        return round(`<rect width="60" height="40" fill="#e30a17"/><circle cx="25" cy="20" r="8" fill="#fff"/><circle cx="27" cy="20" r="8" fill="#e30a17"/><polygon points="34,20 40,18 38,23" fill="#fff"/>`);
                    case "AE":
                        return round(`<rect width="60" height="40" fill="#00732f"/><rect y="13.33" width="60" height="13.34" fill="#fff"/><rect y="26.67" width="60" height="13.33" fill="#000"/><rect width="12" height="40" fill="#ff0000"/>`);
                    case "OM":
                        return round(`<rect width="60" height="40" fill="#db161b"/><rect x="12" width="48" height="20" fill="#fff"/><rect x="12" y="20" width="48" height="20" fill="#007a3d"/>`);
                    case "SA":
                        return round(`<rect width="60" height="40" fill="#006c35"/>`);
                    case "BD":
                        return round(`<rect width="60" height="40" fill="#006a4e"/><circle cx="27" cy="20" r="9" fill="#f42a41"/>`);
                    case "IN":
                        return bands("#ff9933", "#fff", "#128807").replace('</g>', '<circle cx="30" cy="20" r="4" fill="none" stroke="#1a237e" stroke-width="2"/></g>');
                    case "PK":
                        return round(`<rect width="60" height="40" fill="#01411c"/><rect x="0" width="15" height="40" fill="#fff"/>`);
                    case "NP":
                        return round(`<rect width="60" height="40" fill="#003893"/><polygon points="0,0 0,40 30,25 15,25 30,10" fill="#dc143c" stroke="#003893" stroke-width="3"/>`);
                    case "LK":
                        return two("#ff9e1b", "#0a8f3d");
                    case "MM":
                        return bands("#f7e017", "#43b02a", "#ea2839");
                    case "MY":
                        return round(`<rect width="60" height="40" fill="#cc0001"/>${Array.from({length:6}).map((_,i)=>` < rect y = "${(i*2+1)*40/13}"
                            width = "60"
                            height = "${40/13}"
                            fill = "#fff" / > `).join("")}<rect width="26" height="22" fill="#010066"/><circle cx="16" cy="11" r="6" fill="#ffcc00"/><circle cx="18" cy="11" r="6" fill="#010066"/>`);
                    case "PH":
                        return round(`<rect width="60" height="40" fill="#0038a8"/><rect y="20" width="60" height="20" fill="#ce1126"/><polygon points="0,0 0,40 26,20" fill="#fff"/>`);
                    case "ID":
                        return two("#ff0000", "#fff");
                    case "SG":
                        return round(`<rect width="60" height="20" fill="#ee2e3b"/><rect y="20" width="60" height="20" fill="#fff"/><circle cx="14" cy="12" r="7" fill="#fff"/><circle cx="16" cy="12" r="7" fill="#ee2e3b"/>${Array.from({length:5}).map((_,i)=>{const a=(i*72-90)*Math.PI/180, cx=14+6*Math.cos(a), cy=12+6*Math.sin(a); return ` < polygon points = "${cx},${cy-2} ${cx+1.8},${cy+2} ${cx-1.8},${cy+0.7}"
                            fill = "#fff"
                            transform = "rotate(18 ${cx} ${cy})" / > `;}).join("")}`);
                    case "TH":
                        return bands("#ae1c28", "#fff", "#2d2a4a");
                    case "VN":
                        return round(`<rect width="60" height="40" fill="#da251d"/><polygon points="30,10 33,18 41,18 35,23 37,31 30,26 23,31 25,23 19,18 27,18" fill="#ffde00"/>`);
                    case "HK":
                        return round(`<rect width="60" height="40" fill="#de2910"/><g fill="#fff" transform="translate(30 20)">${Array.from({length:5}).map((_,i)=>` < path d = "M0,-10 Q4,-2 0,0 Q-4,-2 0,-10Z"
                            transform = "rotate(${i*72})" / > `).join("")}</g>`);
                    case "CN":
                        return round(`<rect width="60" height="40" fill="#de2910"/><polygon points="12,10 14,16 8,12 16,12 10,16" fill="#ffde00"/>`);
                    case "AU":
                        return round(`<rect width="60" height="40" fill="#012169"/>`);
                    case "KR":
                        return round(`<rect width="60" height="40" fill="#fff"/><g transform="translate(30 20)"><path d="M0,-7 A7,7 0 1 1 0,7 A7,7 0 1 1 0,-7Z" fill="#c60c30"/><path d="M0,7 A7,7 0 1 1 0,-7" fill="#003478"/></g><g stroke="#000" stroke-width="3"><g transform="translate(12,10) rotate(30)"><line x1="-6" y1="-6" x2="6" y2="-6"/><line x1="-6" y1="0" x2="6" y2="0"/><line x1="-6" y1="6" x2="6" y2="6"/></g><g transform="translate(48,30) rotate(30)"><line x1="-6" y1="-6" x2="6" y2="-6"/><line x1="-6" y1="0" x2="6" y2="0"/><line x1="-6" y1="6" x2="6" y2="6"/></g><g transform="translate(48,10) rotate(-30)"><line x1="-6" y1="-6" x2="6" y2="-6"/><line x1="-6" y1="6" x2="6" y2="6"/></g><g transform="translate(12,30) rotate(-30)"><line x1="-6" y1="-6" x2="6" y2="-6"/><line x1="-6" y1="6" x2="6" y2="6"/></g></g>`);
                    default:
                        return two("#2b2d35", "#1f2025");
                }
            }
            const flagBadge = (ccy) => {
                const cc = RATE_COUNTRY[ccy] || "XX";
                return `<div class="flag" title="${esc(ccy)}">${flagSVG(cc)}</div>`;
            };
            const upSVG = () => `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5l7 7M12 5L5 12"/></svg>`;
            const downSVG = () => `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7M12 19L5 12"/></svg>`;

            function pctChip(curr, prev) {
                if (prev == null || curr == null || prev === 0) return `<span class="chip">—</span>`;
                const pct = ((curr - prev) / prev) * 100;
                const s = (pct > 0 ? '+' : '') + pct.toFixed(2) + '%';
                const cls = pct > 0 ? 'good' : (pct < 0 ? 'bad' : '');
                const icon = pct > 0 ? upSVG() : (pct < 0 ? downSVG() : '');
                return `<span class="chip ${cls}">${icon}${s}</span>`;
            }
            async function openRatePicker() {
                const body = document.getElementById('rateBody');
                const sel = document.getElementById('rateMonthSel');
                const liveBody = document.getElementById('liveRatesBody');
                const monthlyBody = document.getElementById('monthlyRatesBody');
                if (!body || !sel || !liveBody || !monthlyBody) return;
                // Tab handling
                const tabs = document.querySelectorAll('#rateModal .tab-btn');
                let activeTab = state.activeRateTab || 'live';
                const months = monthsForCurrentTab();
                const single = selectedMonthForRates();
                // Initialize month selector
                sel.innerHTML = ['All', ...months].map(m => `<option>${esc(m)}</option>`).join('');
                sel.value = (single && months.includes(single)) ? single : 'All';
                // Render functions
                const renderLive = () => {
                    const rates = state.fxCache.live || {};
                    const rows = RATE_ORDERED_CCYS.map(ccy => {
                        const val = rates[ccy];
                        const valStr = (val == null || !isFinite(val)) ? '—' : Number(val).toFixed(6);
                        return `
        <tr>
          <td>
            <div class="ccy">
              ${flagBadge(ccy)}
              <div>
                <div>${esc(ccy)}</div>
                <div class="muted">${esc(RATE_LABEL[ccy] || '')}</div>
              </div>
            </div>
          </td>
          <td><div class="rate mono">${valStr}</div></td>
        </tr>`;
                    }).join('');
                    liveBody.innerHTML = rows;
                };
                const renderMonthly = async () => {
                    const pick = sel.value;
                    const useMonths = (pick === 'All') ? months : [pick];
                    await ensureMonthlyRatesCached(useMonths);
                    const thead = `
  <thead>
    <tr>
      <th>Currency</th>
      ${useMonths.map(m => `<th class="center">${esc(m)}</th>`).join('')}
    </tr>
  </thead>`;
                    // Write into the Monthly tab table
                    const monthlyTable = body.querySelector('#tab-monthly .fx table');
                    if (monthlyTable) {
                        monthlyTable.innerHTML = thead + `<tbody>${rows}</tbody>`;
                    }
                    // (Optional safety) also update the skeleton header row if present
                    const hdrRow = document.querySelector('#tab-monthly thead #monthlyHeaderRow');
                    if (hdrRow) {
                        hdrRow.innerHTML = [
                            '<th>Currency</th>',
                            ...useMonths.map(m => `<th class="center">${esc(m)}</th>`)
                        ].join('');
                    }
                    const rows = RATE_ORDERED_CCYS.map(ccy => {
                        const left = `
        <td>
          <div class="ccy">
            ${flagBadge(ccy)}
            <div>
              <div>${esc(ccy)}</div>
              <div class="muted">${esc(RATE_LABEL[ccy] || '')}</div>
            </div>
          </div>
        </td>`;
                        let prev = null;
                        const tds = useMonths.map(m => {
                            const rr = (state.fxCache?.monthly?.[monthKey(m)]) || {};
                            const val = rr[ccy];
                            const valStr = (val == null || !isFinite(val)) ? '—' : Number(val).toFixed(6);
                            const chip = (prev == null) ? `<span class="chip">—</span>` : pctChip(val, prev);
                            prev = (val == null) ? prev : val;
                            return `<td><div class="rate mono">${valStr}</div><div>${chip}</div></td>`;
                        }).join('');
                        return `<tr>${left}${tds}</tr>`;
                    }).join('');
                    monthlyBody.innerHTML = rows;
                    body.querySelector('#tab-monthly .fx table').innerHTML = thead + `<tbody>${rows}</tbody>`;
                };
                // Tab switcher
                const switchTab = (tab) => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#rateModal .tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelector(`#rateModal .tab-btn[data-tab="${tab}"]`).classList.add('active');
                    document.getElementById(`tab-${tab}`).classList.add('active');
                    state.activeRateTab = tab;
                    sel.classList.toggle('hidden', tab === 'live');
                    document.querySelector('#rateModal .modal-title span').textContent = tab === 'live' ? 'Live Rates' : 'Monthly Rates';
                    if (tab === 'live') {
                        renderLive();
                    } else {
                        renderMonthly();
                    }
                    updateRatePanelTightMode();
                };
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        switchTab(tab.dataset.tab);
                    });
                });
                sel.onchange = async () => {
                    await renderMonthly();
                    updateRatePanelTightMode();
                };
                // Initial render
                switchTab(activeTab);
                rateModal(true);
                updateRatePanelTightMode();
                window.addEventListener('resize', updateRatePanelTightMode);
            }

            function updateRatePanelTightMode() {
                const panel = document.querySelector('#rateModal .modal-panel');
                const body = document.getElementById('rateBody');
                const content = body?.querySelector('.tab-content.active .fx-wrap');
                if (!panel || !content) return;
                const needsScroll = content.scrollHeight > body.clientHeight;
                panel.classList.toggle('tight', !needsScroll);
            }

            function wireRateModal() {
                const btn = document.getElementById('rate');
                btn && btn.addEventListener('click', openRatePicker);
                const modal = document.getElementById('rateModal');
                if (!modal) return;
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-backdrop') || e.target.closest('[data-close]')) {
                        e.preventDefault();
                        rateModal(false);
                    }
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') rateModal(false);
                });
            }
            wireRateModal();

            function applyThemeClass() {
                applyChartThemeToExisting();
            }

            function updateThemeIcon() {
                const isLight = document.body.classList.contains('theme-light');
                const iconName = isLight ? 'sun' : 'moon-star';
                const slot = document.getElementById('themeIcon');
                if (!slot) return;
                slot.innerHTML = `<i data-lucide="${iconName}"></i>`;
                refreshIcons();
            }
            /* ---- Lucide safe refresh (prevents 'icons' undefined) ---- */
            function refreshIcons(root = document) {
                if (!window.lucide || typeof lucide.createIcons !== 'function') return;
                const pack =
                    lucide.icons || (lucide.default && lucide.default.icons) || {};
                if (!pack || !Object.keys(pack).length) return; // nothing to render yet
                lucide.createIcons({
                    icons: pack,
                    nameAttr: 'data-lucide',
                    root
                });
            }
            /* ================== Boot ================== */
            document.addEventListener('DOMContentLoaded', () => {
                const sel = document.getElementById('version');
                // 1) Make sure we prime audio immediately after the *first* gesture:
                primeAudioAfterGesture(); // already defined in your code

                // 2) Apply whatever the current dropdown shows at startup so sources get set:
                applyVersion(sel?.value || 'Current Version');

                // 3) Re-apply when the user changes the dropdown:
                sel?.addEventListener('change', (e) => {
                    applyVersion(e.target.value);
                });
            });
            window.addEventListener('DOMContentLoaded', async () => {
                // First paint: icons + theme
                refreshIcons();
                applyThemeClass();
                updateThemeIcon();
                primeAudioAfterGesture();

                // Brand spinner
                const brandBtn = document.getElementById('brandToggle');
                brandBtn?.addEventListener('click', () => {
                    const modes = ['spin', 'pulse', 'off'];
                    const cur = brandBtn.getAttribute('data-mode') || 'spin';
                    const next = modes[(modes.indexOf(cur) + 1) % modes.length];
                    brandBtn.setAttribute('data-mode', next);
                });

                // Quick filter
                document.getElementById('quick')?.addEventListener('input', (e) => {
                    state.quick = e.target.value || '';
                    rebuildTableForCurrent();
                    refreshIcons();
                });

                // Theme switch
                const themeBtn = document.getElementById('theme');
                themeBtn?.addEventListener('click', () => {
                    document.body.classList.toggle('theme-light');
                    applyThemeClass();
                    updateThemeIcon();
                    primeAudioAfterGesture();
                    applyChartThemeToExisting();
                    refreshIcons();
                });

                // Tabs
                document.querySelectorAll('.tab').forEach((btn) => {
                    btn.addEventListener('click', async () => {
                        document.querySelectorAll('.tab').forEach((x) => x.classList.remove('active'));
                        btn.classList.add('active');
                        state.tab = btn.dataset.tab;
                        await refresh({
                            fromTabSwitch: true
                        });
                        refreshIcons();
                    });
                });

                // ===== Bootstraps (no nested DOMContentLoaded) =====
                try {
                    wireRateModalEvents();
                    wireRateButton();
                    await recordLiveRatesSnapshot();
                    if (typeof applySavedVersionOrAuto === 'function') applySavedVersionOrAuto();
                    setSoundSourcesForVersion(state.version || VERSION_KEYS.DEFAULT);
                } catch (e) {
                    console.warn('Init extras failed:', e);
                }

                // Controls
                document.getElementById('refresh')?.addEventListener('click', async () => {
                    await refresh({
                        forceReload: true
                    });
                    refreshIcons();
                });
                document.getElementById('currency')?.addEventListener('change', async () => {
                    await refresh({
                        reason: 'currency-change'
                    });
                    refreshIcons();
                });
                document.getElementById('rate')?.addEventListener('click', () => openRatePicker());
                document.getElementById('version')?.addEventListener('change', (e) => {
                    applyVersion(e.target.value);
                    refreshIcons();
                });
                wireHelperModal();

                // Layout
                window.addEventListener('resize', () => {
                    document.querySelectorAll('table.tgrid').forEach(syncStickyOffsets);
                    updateRatePanelTightMode();
                });

                // Initial load
                state.tab = 'pr';
                const curSel = document.getElementById('currency');
                if (curSel) curSel.value = 'USD - MonthlyRate';

                setRefreshSpinning(true);
                await fetchLiveRates();
                await refresh({
                    forceReload: true
                });
                refreshIcons();
            });
        </script>
</body>

</html>